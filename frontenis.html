<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torneo de Frontenis ISSEA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.47.0/tabler-icons.min.css">
</head>
<body class="bg-gray-50 p-4 max-w-2xl mx-auto">
    <h1 class="text-2xl font-bold text-center mb-6">Administrador Torneo Frontenis ISSEA</h1>
    <div class="flex justify-center mb-6 space-x-2">
        <button id="tabPrimera" data-category="Primera" class="px-4 py-2 bg-blue-600 text-white rounded">Primera</button>
        <button id="tabSegunda" data-category="Segunda" class="px-4 py-2 bg-gray-200 rounded">Segunda</button>
    </div>

    <div class="flex justify-center mb-6 space-x-2">
        <button id="exportDBBtn" class="px-4 py-2 bg-green-600 text-white rounded">Exportar BD</button>
        <label for="importDBInput" class="px-4 py-2 bg-blue-600 text-white rounded cursor-pointer">Importar BD</label>
        <input type="file" id="importDBInput" accept=".json" class="hidden" />
    </div>

    <section id="infoSection" class="mb-10">
        <h2 class="text-xl font-semibold mb-2">Información del Torneo</h2>
        <p class="mb-2">El torneo se llevará a cabo en el <strong>Deportivo IV Centenario</strong> de Aguascalientes.</p>
        <p class="mb-2">Las jornadas serán los <strong>miércoles</strong> del <strong>9/09/2025</strong> al <strong>30/09/2025</strong>.</p>
        <p class="mb-2">Habrá dos categorías: <strong>Primera</strong> y <strong>Segunda</strong>. Cada jugador solo puede inscribirse en una categoría.</p>
        <p>Las instalaciones cuentan con <strong>2 canchas de Frontenis</strong>.</p>
    </section>

    <section id="playerSection" class="mb-10">
        <h2 class="text-xl font-semibold mb-2">Cédula de Jugador</h2>
        <button id="openPlayerModal" class="bg-blue-600 text-white rounded p-2 mb-2">Añadir Jugador</button>
        <div id="playerModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-60">
            <div class="bg-white rounded-lg shadow-2xl p-4 w-80">
                <form id="playerForm" class="grid grid-cols-1 gap-2">
                    <input id="playerName" placeholder="Nombre" class="border p-2 rounded" required />
                    <input id="playerPhone" placeholder="Teléfono (XXX) XXX XXXX" pattern="\(\d{3}\) \d{3} \d{4}" class="border p-2 rounded" required />
                    <input id="playerAdscripcion" placeholder="Adscripción" class="border p-2 rounded" />
                    <input id="playerTurno" placeholder="Turno" class="border p-2 rounded" />
                    <input id="playerBase" placeholder="Tipo de base" class="border p-2 rounded" />
                    <input id="playerTalla" placeholder="Talla de uniforme" class="border p-2 rounded" />
                    <div class="flex justify-end space-x-2">
                        <button type="button" id="closePlayerModal" class="px-3 py-1 rounded border">Cancelar</button>
                        <button type="submit" class="bg-blue-600 text-white rounded px-3 py-1">Registrar</button>
                    </div>
                </form>
            </div>
        </div>
        <ul id="playerList" class="mt-4 space-y-1 text-sm"></ul>
    </section>

    <section id="pairSection" class="mb-10">
        <h2 class="text-xl font-semibold mb-2">Agregar Pareja</h2>
        <button id="openPairModal" class="bg-blue-500 text-white rounded p-2 mb-2">Añadir Pareja</button>
        <div id="pairModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-60">
            <div class="bg-white rounded-lg shadow-2xl p-4 w-80">
                <form id="pairForm" class="grid grid-cols-1 gap-2">
                    <select id="zagueroSelect" class="border p-2 rounded"></select>
                    <select id="delanteroSelect" class="border p-2 rounded"></select>
                    <div class="flex justify-end space-x-2">
                        <button type="button" id="closePairModal" class="px-3 py-1 rounded border">Cancelar</button>
                        <button type="submit" class="bg-blue-600 text-white rounded px-3 py-1">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
        <ul id="pairList" class="mt-4 space-y-1 text-sm"></ul>
    </section>

    <section id="historySection" class="mb-10">
        <h2 class="text-xl font-semibold mb-2">Historial de Partidos</h2>
        <ul id="historyList" class="space-y-1 text-sm"></ul>
    </section>

    <section id="eliminationSection" class="mb-10">
        <h2 class="text-xl font-semibold mb-2">Eliminatorias</h2>
        <div id="eliminationBracket" class="space-y-2 text-sm"></div>
    </section>

    <section id="matchSection" class="mb-10">
        <h2 class="text-xl font-semibold mb-2">Registrar Partido</h2>
        <div class="mb-2 space-x-2">
            <button id="generateSchedule" class="bg-blue-600 text-white rounded p-2">Generar Calendario</button>
            <button id="openMatchModal" class="bg-green-600 text-white rounded p-2">Registrar Partido</button>
        </div>
        <div id="matchModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-60">
            <div class="bg-white rounded-lg shadow-2xl p-4 w-80">
                <form id="matchForm" class="grid grid-cols-2 gap-2 items-center">
                    <select id="daySelect" class="border p-2 rounded"></select>
                    <select id="courtSelect" class="border p-2 rounded">
                        <option value="">Cancha</option>
                        <option value="1">Cancha 1</option>
                        <option value="2">Cancha 2</option>
                    </select>
                    <select id="timeSelect" class="border p-2 rounded"></select>
                    <select id="pairA" class="border p-2 rounded"></select>
                    <input id="scoreA" type="number" min="0" class="border p-2 rounded" />
                    <span class="col-span-2 text-center">vs</span>
                    <select id="pairB" class="border p-2 rounded"></select>
                    <input id="scoreB" type="number" min="0" class="border p-2 rounded" />
                    <div class="col-span-2 flex justify-end space-x-2">
                        <button type="button" id="closeMatchModal" class="px-3 py-1 rounded border">Cancelar</button>
                        <button type="submit" class="bg-green-600 text-white rounded px-3 py-1">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <section id="statsSection" class="mb-10">
        <h2 class="text-xl font-semibold mb-2">Estadísticas</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-left">
                <thead>
                    <tr class="border-b">
                        <th class="px-2 py-1">Pareja</th>
                        <th class="px-2 py-1">JJ</th>
                        <th class="px-2 py-1">JG</th>
                        <th class="px-2 py-1">JP</th>
                        <th class="px-2 py-1">PF</th>
                        <th class="px-2 py-1">PC</th>
                    </tr>
                </thead>
                <tbody id="statsBody"></tbody>
            </table>
        </div>
    </section>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
import { getFirestore, collection, addDoc, getDocs, onSnapshot, updateDoc, deleteDoc, doc, setDoc } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

// TODO: Reemplaza con la configuración de tu proyecto Firebase
const firebaseConfig = {
    apiKey: "AIzaSyB1pgqjSN60z-QhdBenoEhbpkpLdY7WRyI",
    authDomain: "torneo2025.firebaseapp.com",
    projectId: "torneo2025",
    storageBucket: "torneo2025.appspot.com",
    messagingSenderId: "305813771068",
    appId: "1:305813771068:web:5c5b98ba8c26e5b35ec439",
    measurementId: "G-4X0726QEF8"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const pairForm = document.getElementById('pairForm');
const zagueroSelect = document.getElementById('zagueroSelect');
const delanteroSelect = document.getElementById('delanteroSelect');
const pairModal = document.getElementById('pairModal');
const openPairModalBtn = document.getElementById('openPairModal');
const closePairModalBtn = document.getElementById('closePairModal');
const pairList = document.getElementById('pairList');
const pairASelect = document.getElementById('pairA');
const pairBSelect = document.getElementById('pairB');
const matchForm = document.getElementById('matchForm');
const matchModal = document.getElementById('matchModal');
const openMatchModalBtn = document.getElementById('openMatchModal');
const closeMatchModalBtn = document.getElementById('closeMatchModal');
const courtSelect = document.getElementById('courtSelect');
const timeSelect = document.getElementById('timeSelect');
const daySelect = document.getElementById('daySelect');
const generateScheduleBtn = document.getElementById('generateSchedule');
const statsBody = document.getElementById('statsBody');
const historyList = document.getElementById('historyList');
const eliminationBracket = document.getElementById('eliminationBracket');
const playerForm = document.getElementById('playerForm');
const playerModal = document.getElementById('playerModal');
const openPlayerModalBtn = document.getElementById('openPlayerModal');
const closePlayerModalBtn = document.getElementById('closePlayerModal');
const playerList = document.getElementById('playerList');
const categoryTabs = document.querySelectorAll('[data-category]');

let currentCategory = 'Primera';

let currentPairs = [];
let currentMatches = [];
let currentPlayers = [];
let editingPairId = null;
let editingMatchId = null;
let editingPlayerId = null;

const availableDays = ['2025-09-09','2025-09-16','2025-09-23','2025-09-30'];
const courts = ['1','2'];
const timeSlots = [];
for (let h=16; h<20; h++) { timeSlots.push(`${h}:00`); timeSlots.push(`${h}:30`); }

function fillDayOptions() {
    daySelect.innerHTML = '<option value="">Día</option>';
    availableDays.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = d;
        daySelect.appendChild(opt);
    });
}

openPlayerModalBtn.onclick = () => {
    playerForm.reset();
    playerModal.classList.remove('hidden');
};
closePlayerModalBtn.onclick = () => playerModal.classList.add('hidden');

courtSelect.onchange = fillTimeOptions;
daySelect.onchange = fillTimeOptions;
generateScheduleBtn.onclick = generateRoundRobin;

openPairModalBtn.onclick = () => {
    fillPlayerSelects();
    pairForm.reset();
    pairModal.classList.remove('hidden');
};
closePairModalBtn.onclick = () => pairModal.classList.add('hidden');

openMatchModalBtn.onclick = () => {
    matchForm.reset();
    matchForm.dataset.stage = 'RR';
    editingMatchId = null;
    fillDayOptions();
    fillTimeOptions();
    matchModal.classList.remove('hidden');
};
closeMatchModalBtn.onclick = () => {
    matchModal.classList.add('hidden');
    editingMatchId = null;
};

categoryTabs.forEach(t => {
    t.addEventListener('click', () => {
        currentCategory = t.dataset.category;
        updateTabStyles();
        refreshUI();
    });
});

function updateTabStyles() {
    categoryTabs.forEach(t => {
        if (t.dataset.category === currentCategory) {
            t.classList.add('bg-blue-600','text-white');
            t.classList.remove('bg-gray-200');
        } else {
            t.classList.remove('bg-blue-600','text-white');
            t.classList.add('bg-gray-200');
        }
    });
}

function fillPlayerSelects() {
    [zagueroSelect, delanteroSelect].forEach(sel => {
        sel.innerHTML = '<option value="">Jugador</option>';
        currentPlayers.filter(p => p.category === currentCategory).forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.name;
            opt.textContent = p.name;
            sel.appendChild(opt);
        });
    });
}

function formatTime(t) {
    const [h,m] = t.split(':').map(Number);
    const hour = ((h + 11) % 12) + 1;
    const suf = h >= 12 ? 'PM' : 'AM';
    return `${hour}:${m.toString().padStart(2,'0')} ${suf}`;
}

function fillTimeOptions() {
    timeSelect.innerHTML = '<option value="">Horario</option>';
    const selectedCourt = courtSelect.value;
    const selectedDay = daySelect.value;
    const taken = currentMatches.filter(m => m.court === selectedCourt && m.day === selectedDay && (!editingMatchId || m.id !== editingMatchId)).map(m => m.time);
    timeSlots.forEach(t => {
        if (selectedCourt && selectedDay && taken.includes(t)) return;
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = formatTime(t);
        timeSelect.appendChild(opt);
    });
    if (editingMatchId) {
        const match = currentMatches.find(m => m.id === editingMatchId);
        if (match && match.court === selectedCourt && match.day === selectedDay && !timeSlots.includes(match.time)) {
            const opt = document.createElement('option');
            opt.value = match.time;
            opt.textContent = formatTime(match.time);
            timeSelect.appendChild(opt);
        }
    }
}

function refreshUI() {
    const pairs = currentPairs.filter(p => p.category === currentCategory);
    const matches = currentMatches.filter(m => m.category === currentCategory);
    renderPairs(pairs);
    renderStats(computeStats(pairs, matches.filter(m => (m.stage || 'RR') === 'RR')));
    renderHistory(pairs, matches);
    maybeGenerateElimination(pairs, matches);
    maybeGenerateFinals(pairs, matches);
    renderElimination(pairs, matches);
    fillDayOptions();
    fillTimeOptions();
}

playerForm.onsubmit = async e => {
    e.preventDefault();
    const data = {
        name: document.getElementById('playerName').value.trim(),
        category: currentCategory,
        phone: document.getElementById('playerPhone').value.trim(),
        adscripcion: document.getElementById('playerAdscripcion').value.trim(),
        turno: document.getElementById('playerTurno').value.trim(),
        base: document.getElementById('playerBase').value.trim(),
        talla: document.getElementById('playerTalla').value.trim()
    };
    if (!data.name) return;
    if (editingPlayerId) {
        await updateDoc(doc(db, 'players', editingPlayerId), data);
        editingPlayerId = null;
    } else {
        await addDoc(collection(db, 'players'), data);
    }
    playerForm.reset();
    playerModal.classList.add('hidden');
};

pairForm.onsubmit = async e => {
    e.preventDefault();
    const zaguero = zagueroSelect.value;
    const delantero = delanteroSelect.value;
    if (!zaguero || !delantero) return;
    const data = { zaguero, delantero, category: currentCategory };
    if (editingPairId) {
        await updateDoc(doc(db, 'pairs', editingPairId), data);
        editingPairId = null;
    } else {
        await addDoc(collection(db, 'pairs'), data);
    }
    pairForm.reset();
    pairModal.classList.add('hidden');
};

matchForm.onsubmit = async e => {
    e.preventDefault();
    const pairA = pairASelect.value;
    const pairB = pairBSelect.value;
    const day = daySelect.value;
    const court = courtSelect.value;
    const time = timeSelect.value;
    const scoreA = parseInt(document.getElementById('scoreA').value) || 0;
    const scoreB = parseInt(document.getElementById('scoreB').value) || 0;
    if (!pairA || !pairB || pairA === pairB || !court || !time || !day) return;
    const conflict = currentMatches.some(m => m.category === currentCategory && m.court === court && m.day === day && m.time === time && m.id !== editingMatchId);
    if (conflict) { alert('Horario no disponible'); return; }
    const stage = matchForm.dataset.stage || 'RR';
    const data = { pairA, pairB, scoreA, scoreB, stage, category: currentCategory, court, time, day, ts: Date.now() };
    if (editingMatchId) {
        await updateDoc(doc(db, 'matches', editingMatchId), data);
        editingMatchId = null;
    } else {
        await addDoc(collection(db, 'matches'), data);
    }
    matchForm.reset();
    fillTimeOptions();
    matchModal.classList.add('hidden');
};

function renderPairs(pairs) {
    pairList.innerHTML = '';
    pairASelect.innerHTML = '<option value="">Pareja A</option>';
    pairBSelect.innerHTML = '<option value="">Pareja B</option>';
    pairs.forEach(p => {
        const li = document.createElement('li');
        li.innerHTML = `${p.zaguero} / ${p.delantero} <button data-edit="${p.id}" class="text-blue-600"><i class="ti ti-pencil"></i></button> <button data-del="${p.id}" class="text-red-600"><i class="ti ti-trash"></i></button>`;
        pairList.appendChild(li);

        const optA = document.createElement('option');
        optA.value = p.id;
        optA.textContent = `${p.zaguero} / ${p.delantero}`;
        pairASelect.appendChild(optA);
        const optB = optA.cloneNode(true);
        pairBSelect.appendChild(optB);
    });
}

function renderPlayers(players) {
    playerList.innerHTML = '';
    players.forEach(p => {
        const li = document.createElement('li');
        li.innerHTML = `${p.name} (${p.category}) <button data-edit="${p.id}" class="text-blue-600"><i class="ti ti-pencil"></i></button> <button data-del="${p.id}" class="text-red-600"><i class="ti ti-trash"></i></button>`;
        playerList.appendChild(li);
    });
}

pairList.onclick = async e => {
    if (e.target.dataset.edit) {
        const id = e.target.dataset.edit;
        const pair = currentPairs.find(p => p.id === id);
        if (pair) {
            fillPlayerSelects();
            zagueroSelect.value = pair.zaguero;
            delanteroSelect.value = pair.delantero;
            editingPairId = id;
            pairModal.classList.remove('hidden');
        }
    } else if (e.target.dataset.del) {
        const id = e.target.dataset.del;
        if (confirm('Eliminar pareja?')) {
            await deleteDoc(doc(db, 'pairs', id));
        }
    }
};

playerList.onclick = async e => {
    if (e.target.closest('button')?.dataset.edit) {
        const id = e.target.closest('button').dataset.edit;
        const player = currentPlayers.find(p => p.id === id);
        if (player) {
            document.getElementById('playerName').value = player.name;
            document.getElementById('playerPhone').value = player.phone;
            document.getElementById('playerAdscripcion').value = player.adscripcion;
            document.getElementById('playerTurno').value = player.turno;
            document.getElementById('playerBase').value = player.base;
            document.getElementById('playerTalla').value = player.talla;
            editingPlayerId = id;
            playerModal.classList.remove('hidden');
        }
    } else if (e.target.closest('button')?.dataset.del) {
        const id = e.target.closest('button').dataset.del;
        if (confirm('Eliminar jugador?')) {
            await deleteDoc(doc(db, 'players', id));
        }
    }
};

function computeStats(pairs, matches) {
    const stats = {};
    pairs.forEach(p => stats[p.id] = { id: p.id, name: `${p.zaguero} / ${p.delantero}`, jj:0, jg:0, jp:0, pf:0, pc:0 });
    matches.forEach(m => {
        const a = stats[m.pairA];
        const b = stats[m.pairB];
        if (!a || !b) return;
        a.jj++; b.jj++;
        a.pf += m.scoreA; a.pc += m.scoreB;
        b.pf += m.scoreB; b.pc += m.scoreA;
        if (m.scoreA > m.scoreB) { a.jg++; b.jp++; }
        else if (m.scoreB > m.scoreA) { b.jg++; a.jp++; }
    });
    return Object.values(stats);
}

async function maybeGenerateElimination(pairs, matches) {
    const rrMatches = matches.filter(m => (m.stage || 'RR') === 'RR');
    const sfMatches = matches.filter(m => m.stage === 'SF');
    const expected = pairs.length * (pairs.length - 1) / 2;
    if (sfMatches.length || rrMatches.length < expected || pairs.length < 4) return;
    const stats = computeStats(pairs, rrMatches);
    stats.sort((a,b) => b.jg - a.jg || (b.pf - b.pc) - (a.pf - a.pc));
    const top4 = stats.slice(0,4);
    if (top4.length < 4) return;
    const pad = n => n.toString().padStart(2,'0');
    const fmt = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const last = new Date(availableDays[availableDays.length-1]);
    last.setDate(last.getDate()+7);
    const day = fmt(last);
    const ts = Date.now();
    const games = [
        {pairA:top4[0].id, pairB:top4[3].id, day, court:courts[0], time:timeSlots[0], scoreA:0, scoreB:0, stage:'SF', match:'SF1', category:currentCategory, ts},
        {pairA:top4[1].id, pairB:top4[2].id, day, court:courts[1]||courts[0], time:timeSlots[0], scoreA:0, scoreB:0, stage:'SF', match:'SF2', category:currentCategory, ts}
    ];
    for (const g of games) {
        await addDoc(collection(db,'matches'), g);
    }
}

async function maybeGenerateFinals(pairs, matches) {
    const sf1 = matches.find(m => m.stage === 'SF' && m.match === 'SF1');
    const sf2 = matches.find(m => m.stage === 'SF' && m.match === 'SF2');
    if (!sf1 || !sf2) return;
    const finalExists = matches.some(m => m.stage === 'F');
    const thirdExists = matches.some(m => m.stage === '3P');
    if (finalExists && thirdExists) return;
    if (sf1.scoreA === sf1.scoreB && sf1.scoreA === 0) return;
    if (sf2.scoreA === sf2.scoreB && sf2.scoreA === 0) return;
    const pad = n => n.toString().padStart(2,'0');
    const fmt = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const sfDay = new Date(sf1.day);
    sfDay.setDate(sfDay.getDate()+7);
    const day = fmt(sfDay);
    const ts = Date.now();
    const win1 = sf1.scoreA > sf1.scoreB ? sf1.pairA : sf1.pairB;
    const win2 = sf2.scoreA > sf2.scoreB ? sf2.pairA : sf2.pairB;
    const lose1 = sf1.scoreA > sf1.scoreB ? sf1.pairB : sf1.pairA;
    const lose2 = sf2.scoreA > sf2.scoreB ? sf2.pairB : sf2.pairA;
    if (!finalExists) {
        await addDoc(collection(db,'matches'), {pairA:win1, pairB:win2, day, court:courts[0], time:timeSlots[0], scoreA:0, scoreB:0, stage:'F', match:'F', category:currentCategory, ts});
    }
    if (!thirdExists) {
        await addDoc(collection(db,'matches'), {pairA:lose1, pairB:lose2, day, court:courts[1]||courts[0], time:timeSlots[0], scoreA:0, scoreB:0, stage:'3P', match:'3P', category:currentCategory, ts});
    }
}


function renderStats(stats) {
    statsBody.innerHTML = '';
    stats.forEach(s => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="px-2 py-1">${s.name}</td><td>${s.jj}</td><td>${s.jg}</td><td>${s.jp}</td><td>${s.pf}</td><td>${s.pc}</td>`;
        statsBody.appendChild(tr);
    });
}

function renderHistory(pairs, matches) {
    const map = Object.fromEntries(pairs.map(p => [p.id, `${p.zaguero} / ${p.delantero}`]));
    historyList.innerHTML = '';
    matches.sort((a,b) => a.ts - b.ts);
    matches.forEach(m => {
        const stage = m.stage || 'RR';
        const li = document.createElement('li');
        li.innerHTML = `${stage}: ${map[m.pairA] || '?'} ${m.scoreA}-${m.scoreB} ${map[m.pairB] || '?'} (${m.day || '?'} C${m.court || '?'} ${m.time ? formatTime(m.time) : ''}) <button data-edit="${m.id}" class="text-blue-600"><i class="ti ti-pencil"></i></button> <button data-del="${m.id}" class="text-red-600"><i class="ti ti-trash"></i></button>`;
        historyList.appendChild(li);
    });
}

historyList.onclick = async e => {
    if (e.target.dataset.edit) {
        const id = e.target.dataset.edit;
        const match = currentMatches.find(m => m.id === id);
        if (match) {
            pairASelect.value = match.pairA;
            pairBSelect.value = match.pairB;
            document.getElementById('scoreA').value = match.scoreA;
            document.getElementById('scoreB').value = match.scoreB;
            daySelect.value = match.day || '';
            courtSelect.value = match.court || '';
            fillTimeOptions();
            timeSelect.value = match.time || '';
            matchForm.dataset.stage = match.stage || 'RR';
            editingMatchId = id;
            matchModal.classList.remove('hidden');
        }
    } else if (e.target.dataset.del) {
        const id = e.target.dataset.del;
        if (confirm('Eliminar partido?')) {
            await deleteDoc(doc(db, 'matches', id));
        }
    }
};

function renderElimination(pairs, matches) {
    const rrMatches = matches.filter(m => (m.stage || 'RR') === 'RR');
    const stats = computeStats(pairs, rrMatches);
    stats.sort((a,b) => b.jg - a.jg || (b.pf - b.pc) - (a.pf - a.pc));
    const top4 = stats.slice(0,4);
    const map = Object.fromEntries(pairs.map(p => [p.id, `${p.zaguero} / ${p.delantero}`]));
    const sfMatches = matches.filter(m => m.stage === 'SF');
    const fMatch = matches.find(m => m.stage === 'F');

    eliminationBracket.innerHTML = '';
    if (top4.length < 4) {
        eliminationBracket.textContent = 'Esperando resultados de ronda inicial.';
        return;
    }

    const sf1 = sfMatches.find(m => m.match === 'SF1');
    const sf2 = sfMatches.find(m => m.match === 'SF2');

    const createSFForm = (label, aId, bId, dataMatch, existing) => {
        const form = document.createElement('form');
        form.className = 'grid grid-cols-2 gap-2 items-center';
        form.dataset.stage = 'SF';
        form.dataset.match = dataMatch;
        form.innerHTML = `
            <span class="col-span-2 font-semibold">${label}</span>
            <select class="border p-2 rounded" name="a"></select>
            <input class="border p-2 rounded" name="sa" type="number" min="0" />
            <span class="col-span-2 text-center">vs</span>
            <select class="border p-2 rounded" name="b"></select>
            <input class="border p-2 rounded" name="sb" type="number" min="0" />
            <button type="submit" class="bg-green-600 text-white rounded p-2 col-span-2">Guardar</button>`;
        const selA = form.querySelector('select[name="a"]');
        const selB = form.querySelector('select[name="b"]');
        [aId,bId].forEach((id,idx) => {
            const opt = document.createElement('option');
            opt.value = id;
            opt.textContent = map[id];
            if (idx===0) selA.appendChild(opt); else selB.appendChild(opt);
        });
        if (existing) {
            selA.value = existing.pairA;
            selB.value = existing.pairB;
            form.querySelector('input[name="sa"]').value = existing.scoreA;
            form.querySelector('input[name="sb"]').value = existing.scoreB;
        }
        form.onsubmit = async ev => {
            ev.preventDefault();
            const pairA = selA.value;
            const pairB = selB.value;
            const scoreA = parseInt(form.querySelector('input[name="sa"]').value)||0;
            const scoreB = parseInt(form.querySelector('input[name="sb"]').value)||0;
            const data = { pairA, pairB, scoreA, scoreB, stage:'SF', match:dataMatch, ts:Date.now() };
            if (existing) {
                await updateDoc(doc(db,'matches', existing.id), data);
            } else {
                await addDoc(collection(db,'matches'), data);
            }
            form.reset();
        };
        return form;
    };

    eliminationBracket.appendChild(createSFForm('Semifinal 1', top4[0].id, top4[3].id, 'SF1', sf1));
    eliminationBracket.appendChild(createSFForm('Semifinal 2', top4[1].id, top4[2].id, 'SF2', sf2));

    const createFinalForm = (existing) => {
        if (!sf1 || !sf2) {
            const div = document.createElement('div');
            div.textContent = 'Esperando semifinales.';
            return div;
        }
        const winners = [];
        [sf1, sf2].forEach(sf => {
            if (sf.scoreA > sf.scoreB) winners.push(sf.pairA); else if (sf.scoreB > sf.scoreA) winners.push(sf.pairB);
        });
        if (winners.length < 2) {
            const div = document.createElement('div');
            div.textContent = 'Esperando semifinales.';
            return div;
        }
        const form = document.createElement('form');
        form.className = 'grid grid-cols-2 gap-2 items-center mt-4';
        form.dataset.stage = 'F';
        form.innerHTML = `
            <span class="col-span-2 font-semibold">Final</span>
            <select class="border p-2 rounded" name="a"></select>
            <input class="border p-2 rounded" name="sa" type="number" min="0" />
            <span class="col-span-2 text-center">vs</span>
            <select class="border p-2 rounded" name="b"></select>
            <input class="border p-2 rounded" name="sb" type="number" min="0" />
            <button type="submit" class="bg-green-600 text-white rounded p-2 col-span-2">Guardar</button>`;
        const selA = form.querySelector('select[name="a"]');
        const selB = form.querySelector('select[name="b"]');
        winners.forEach((id,idx)=>{
            const opt = document.createElement('option');
            opt.value = id;
            opt.textContent = map[id];
            if(idx===0) selA.appendChild(opt); else selB.appendChild(opt);
        });
        if (existing) {
            selA.value = existing.pairA;
            selB.value = existing.pairB;
            form.querySelector('input[name="sa"]').value = existing.scoreA;
            form.querySelector('input[name="sb"]').value = existing.scoreB;
        }
        form.onsubmit = async ev => {
            ev.preventDefault();
            const pairA = selA.value;
            const pairB = selB.value;
            const scoreA = parseInt(form.querySelector('input[name="sa"]').value)||0;
            const scoreB = parseInt(form.querySelector('input[name="sb"]').value)||0;
            const data = { pairA, pairB, scoreA, scoreB, stage:'F', ts:Date.now() };
            if (existing) {
                await updateDoc(doc(db,'matches', existing.id), data);
            } else {
                await addDoc(collection(db,'matches'), data);
            }
            form.reset();
        };
        return form;
    };

    const createThirdForm = (existing) => {
        if (!sf1 || !sf2) {
            const div = document.createElement('div');
            div.textContent = 'Esperando semifinales.';
            return div;
        }
        const losers = [];
        [sf1, sf2].forEach(sf => {
            if (sf.scoreA > sf.scoreB) losers.push(sf.pairB); else if (sf.scoreB > sf.scoreA) losers.push(sf.pairA);
        });
        if (losers.length < 2) {
            const div = document.createElement('div');
            div.textContent = 'Esperando semifinales.';
            return div;
        }
        const form = document.createElement('form');
        form.className = 'grid grid-cols-2 gap-2 items-center mt-4';
        form.dataset.stage = '3P';
        form.innerHTML = `
            <span class="col-span-2 font-semibold">Tercer Lugar</span>
            <select class="border p-2 rounded" name="a"></select>
            <input class="border p-2 rounded" name="sa" type="number" min="0" />
            <span class="col-span-2 text-center">vs</span>
            <select class="border p-2 rounded" name="b"></select>
            <input class="border p-2 rounded" name="sb" type="number" min="0" />
            <button type="submit" class="bg-green-600 text-white rounded p-2 col-span-2">Guardar</button>`;
        const selA = form.querySelector('select[name="a"]');
        const selB = form.querySelector('select[name="b"]');
        losers.forEach((id,idx)=>{
            const opt = document.createElement('option');
            opt.value = id;
            opt.textContent = map[id];
            if(idx===0) selA.appendChild(opt); else selB.appendChild(opt);
        });
        if (existing) {
            selA.value = existing.pairA;
            selB.value = existing.pairB;
            form.querySelector('input[name="sa"]').value = existing.scoreA;
            form.querySelector('input[name="sb"]').value = existing.scoreB;
        }
        form.onsubmit = async ev => {
            ev.preventDefault();
            const pairA = selA.value;
            const pairB = selB.value;
            const scoreA = parseInt(form.querySelector('input[name="sa"]').value)||0;
            const scoreB = parseInt(form.querySelector('input[name="sb"]').value)||0;
            const data = { pairA, pairB, scoreA, scoreB, stage:'3P', ts:Date.now() };
            if (existing) {
                await updateDoc(doc(db,'matches', existing.id), data);
            } else {
                await addDoc(collection(db,'matches'), data);
            }
            form.reset();
        };
        return form;
    };

    eliminationBracket.appendChild(createFinalForm(fMatch));
    const thirdMatch = matches.find(m => m.stage === '3P');
    eliminationBracket.appendChild(createThirdForm(thirdMatch));
}

async function loadData() {
    const pairSnap = await getDocs(collection(db, 'pairs'));
    const pairs = pairSnap.docs.map(d => ({ id: d.id, ...d.data() }));
    const matchSnap = await getDocs(collection(db, 'matches'));
    const matches = matchSnap.docs.map(d => ({ id: d.id, ...d.data() }));
    const playerSnap = await getDocs(collection(db, 'players'));
    const players = playerSnap.docs.map(d => ({ id: d.id, ...d.data() }));
    currentPairs = pairs;
    currentMatches = matches;
    currentPlayers = players;
    renderPlayers(players);
    refreshUI();
}

async function generateRoundRobin() {
    const pairs = currentPairs.filter(p => p.category === currentCategory);
    if (pairs.length < 2) { alert('Se requieren al menos dos parejas'); return; }
    const existing = currentMatches.filter(m => m.category === currentCategory && (m.stage || 'RR') === 'RR');
    if (existing.length && !confirm('Ya existe un rol. ¿Deseas reemplazarlo?')) return;
    for (const m of existing) { await deleteDoc(doc(db,'matches', m.id)); }
    let ids = pairs.map(p => p.id);
    if (ids.length % 2 === 1) ids.push(null);
    const numRounds = ids.length - 1;
    const half = ids.length / 2;
    let arr = ids.slice();
    let schedule = [];
    for (let r=0; r<numRounds; r++) {
        const day = availableDays[r % availableDays.length];
        let timeIdx = 0, courtIdx = 0;
        for (let i=0; i<half; i++) {
            const a = arr[i];
            const b = arr[arr.length-1-i];
            if (a && b) {
                const time = timeSlots[timeIdx];
                const court = courts[courtIdx];
                schedule.push({pairA:a, pairB:b, day, court, time, scoreA:0, scoreB:0, stage:'RR', category:currentCategory, ts:Date.now()});
                courtIdx++;
                if (courtIdx >= courts.length) { courtIdx = 0; timeIdx++; }
            }
        }
        arr.splice(1,0,arr.pop());
    }
    for (const m of schedule) { await addDoc(collection(db,'matches'), m); }
    alert('Rol generado');
}

async function exportDatabase() {
    const [pairSnap, matchSnap, playerSnap] = await Promise.all([
        getDocs(collection(db, 'pairs')),
        getDocs(collection(db, 'matches')),
        getDocs(collection(db, 'players'))
    ]);
    const data = {
        pairs: pairSnap.docs.map(d => ({ id: d.id, ...d.data() })),
        matches: matchSnap.docs.map(d => ({ id: d.id, ...d.data() })),
        players: playerSnap.docs.map(d => ({ id: d.id, ...d.data() }))
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'torneo-datos.json';
    a.click();
    URL.revokeObjectURL(url);
}

async function importDatabase(file) {
    const text = await file.text();
    const data = JSON.parse(text);
    if (data.players) {
        for (const p of data.players) {
            await setDoc(doc(db, 'players', p.id), p);
        }
    }
    if (data.pairs) {
        for (const p of data.pairs) {
            await setDoc(doc(db, 'pairs', p.id), p);
        }
    }
    if (data.matches) {
        for (const m of data.matches) {
            await setDoc(doc(db, 'matches', m.id), m);
        }
    }
    alert('Datos importados correctamente');
}

document.getElementById('exportDBBtn').addEventListener('click', exportDatabase);
document.getElementById('importDBInput').addEventListener('change', e => {
    if (e.target.files[0]) {
        importDatabase(e.target.files[0]);
    }
});

onSnapshot(collection(db, 'pairs'), loadData);
onSnapshot(collection(db, 'matches'), loadData);
onSnapshot(collection(db, 'players'), loadData);
updateTabStyles();
loadData();
</script>
</body>
</html>
