<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torneo de Frontenis ISSEA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.47.0/tabler-icons.min.css">
    <style>
        .glass-card {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(6px);
            border-radius: 1rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        .glass-hero {
            background: rgba(255, 255, 255, 0.25);
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 2px solid rgba(255, 255, 255, 0.6);
            border-left: 2px solid rgba(255, 255, 255, 0.6);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            border-right: 2px solid rgba(255, 255, 255, 0.1);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.5);
            z-index: 9998;
        }
        .modal-window {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }
        @media (max-width: 640px) {
            .responsive-table thead {
                display: none;
            }
            .responsive-table tr {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 0.25rem;
                border-bottom-width: 1px;
                padding-bottom: 0.5rem;
                margin-bottom: 0.5rem;
            }
            .responsive-table td {
                display: flex;
                justify-content: space-between;
                width: 100%;
            }
            .responsive-table td::before {
                content: attr(data-label);
                font-weight: 600;
            }
        }
        html {
            background-image: url('FondoPatron.jpg');
            background-repeat: repeat;
        }
    </style>
</head>
<body>
    <div id="passwordOverlay" class="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-75">
        <div class="bg-white p-4 rounded shadow">
            <label for="passwordInput" class="block mb-2">Contrase√±a:</label>
            <input id="passwordInput" type="password" class="border p-2 rounded mb-2" />
            <button id="passwordSubmit" class="bg-blue-600 text-white rounded px-4 py-2 mx-auto block">Entrar</button>
            <p id="passwordError" class="text-red-500 mt-2 hidden">Contrase√±a incorrecta</p>
        </div>
    </div>
    <div id="mainContent" class="hidden">

    <section id="hero" class="h-screen flex items-center justify-center bg-cover bg-center">
        <div class="glass-hero p-6 text-center">
            <img src="LogoFrontenis.png" alt="Logo Frontenis" class="w-40 sm:w-60 mx-auto mb-4">
            <h1 class="text-4xl font-bold">Torneo 2025</h1>
        </div>
    </section>

    <div class="max-w-2xl mx-auto p-4">

    <section id="infoSection" class="glass-card p-4 mb-10 space-y-2">
        <h2 class="text-xl font-semibold mb-4 text-center">Informaci√≥n del Torneo</h2>

        <p><strong>Torneo de Frontenis ISSEA 2025</strong></p>
        <p><strong>Lugar:</strong> Deportivo IV Centenario, Aguascalientes</p>
        <p><strong>Fechas:</strong> Mi√©rcoles del 9 al 30 de septiembre de 2025</p>
        <p><strong>Categor√≠as:</strong> Primera (Avanzados) y Segunda (Novatos)</p>
        <p><strong>Formato:</strong> Round Robin + Eliminaci√≥n Directa</p>

        <details class="mt-2">
            <summary class="font-semibold cursor-pointer">üìã BASES GENERALES</summary>
            <div class="space-y-2 mt-2">
                <h3 class="font-semibold">Participantes:</h3>
                <ul class="list-disc pl-6">
                    <li>Podr√°n inscribirse trabajadores adscritos al ISSEA.</li>
                    <li>Cada jugador deber√° registrarse con nombre completo, tel√©fono, adscripci√≥n, turno, tipo de base y talla de uniforme.</li>
                    <li>Cada jugador s√≥lo podr√° participar en una categor√≠a.</li>
                </ul>

                <h3 class="font-semibold">Parejas:</h3>
                <ul class="list-disc pl-6">
                    <li>Las parejas se conformar√°n con un zaguero y un delantero.</li>
                    <li>No se permite repetir jugadores en m√°s de una pareja.</li>
                    <li>Cada pareja representar√° a una categor√≠a (Primera o Segunda).</li>
                </ul>

                <h3 class="font-semibold">Sistema de competencia:</h3>
                <ul class="list-disc pl-6">
                    <li>Fase de grupos: Round Robin (todos contra todos).</li>
                    <li>Fase final: Los 4 mejores avanzan a semifinales.</li>
                    <li>1¬∞ vs 2¬∞ lugar disputan la Final</li>
                    <li>3¬∞ vs 4¬∞ lugar disputan el Tercer Lugar</li>
                </ul>

                <h3 class="font-semibold">Criterios de desempate:</h3>
                <ul class="list-disc pl-6">
                    <li>Mayor n√∫mero de partidos ganados</li>
                    <li>Diferencia de puntos a favor y en contra</li>
                    <li>Resultado directo entre las parejas empatadas</li>
                </ul>

                <h3 class="font-semibold">Calendario y horarios:</h3>
                <ul class="list-disc pl-6">
                    <li>Las jornadas se jugar√°n los mi√©rcoles.</li>
                    <li>Horarios disponibles: entre 16:00 y 20:00 horas.</li>
                    <li>El rol se asignar√° al azar</li>
                </ul>
            </div>
        </details>

        <details class="mt-4">
            <summary class="font-semibold cursor-pointer">üèÅ REGLAMENTO DE JUEGO</summary>
            <div class="space-y-2 mt-2">
                <h4 class="font-semibold">Reglas t√©cnicas:</h4>
                <ul class="list-disc pl-6">
                    <li>Se jugar√° bajo el reglamento oficial de frontenis Preol√≠mpico.</li>
                    <li>Cada partido se jugar√° a un m√°ximo de 3 sets.</li>
                    <li>Se permite calentar 5 minutos antes de cada partido.</li>
                </ul>

                <h4 class="font-semibold">Puntaje:</h4>
                <ul class="list-disc pl-6">
                    <li>Partido ganado: 1 punto</li>
                    <li>Partido perdido: 0 puntos</li>
                    <li>Partido no jugado por inasistencia: derrota autom√°tica con marcador 1-0</li>
                </ul>

                <h4 class="font-semibold">Inasistencias y sanciones:</h4>
                <ul class="list-disc pl-6">
                    <li>Si una pareja no se presenta pasados 10 minutos del horario establecido, perder√° por default.</li>
                    <li>Dos inasistencias consecutivas descalifican autom√°ticamente a la pareja.</li>
                </ul>

                <h4 class="font-semibold">Cambios o sustituciones:</h4>
                <p>No se permiten cambios de jugadores una vez iniciado el torneo, salvo causa de fuerza mayor, justificada ante el comit√© organizador.</p>
            </div>
        </details>

        <details class="mt-4">
            <summary class="font-semibold cursor-pointer">üìù DISPOSICIONES FINALES</summary>
            <ul class="list-disc pl-6 mt-2">
                <li>Cualquier situaci√≥n no prevista ser√° resuelta por el comit√© organizador.</li>
                <li>La participaci√≥n implica la aceptaci√≥n total de estas bases y reglamento.</li>
                <li>El torneo promueve la sana convivencia, por lo que se espera respeto y deportivismo en todo momento.</li>
                <li>El comit√© organizador se reserva el derecho de modificar el presente reglamento por causas justificadas.</li>
            </ul>
        </details>
    </section>

    <section id="playerSection" class="glass-card p-4 mb-10 text-center">
        <h2 class="text-xl font-semibold mb-2 text-center">Jugadores</h2>
        <button id="openPlayerModal" class="bg-blue-600 text-white rounded p-2 mb-2 mx-auto block">A√±adir Jugador</button>
        <details class="mt-4">
            <summary class="font-semibold cursor-pointer">Listado de Jugadores</summary>
            <div class="flex items-center mt-2">
                <input id="playerSearch" type="text" placeholder="Buscar..." class="border p-2 rounded w-full" />
                <button id="clearPlayerSearch" type="button" class="ml-2 px-2 py-1 bg-gray-200 rounded">‚úï</button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm mt-2 responsive-table">
                    <thead>
                        <tr class="border-b">
                            <th class="px-2 py-1">Nombre</th>
                            <th class="px-2 py-1">Categor√≠a</th>
                            <th class="px-2 py-1"></th>
                        </tr>
                    </thead>
                    <tbody id="playerList"></tbody>
                </table>
            </div>
        </details>
    </section>

    <section id="pairSection" class="glass-card p-4 mb-10 text-center">
        <h2 class="text-xl font-semibold mb-2 text-center">Parejas</h2>
        <button id="openPairModal" class="bg-blue-500 text-white rounded p-2 mb-2 mx-auto block">Crear Pareja</button>
        <details class="mt-4">
            <summary class="font-semibold cursor-pointer">Listado de Parejas</summary>
            <div class="flex items-center mt-2">
                <input id="pairSearch" type="text" placeholder="Buscar..." class="border p-2 rounded w-full" />
                <button id="clearPairSearch" type="button" class="ml-2 px-2 py-1 bg-gray-200 rounded">‚úï</button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm mt-2 responsive-table">
                    <thead>
                        <tr class="border-b">
                            <th class="px-2 py-1">Zaguero</th>
                            <th class="px-2 py-1">Delantero</th>
                            <th class="px-2 py-1">Categor√≠a</th>
                            <th class="px-2 py-1"></th>
                        </tr>
                    </thead>
                    <tbody id="pairList"></tbody>
                </table>
            </div>
        </details>
</section>

    <div class="flex justify-center mb-6 space-x-2">
        <button id="tabPrimera" data-category="Primera" class="px-4 py-2 bg-blue-600 text-white rounded">Primera</button>
        <button id="tabSegunda" data-category="Segunda" class="px-4 py-2 bg-gray-200 rounded">Segunda</button>
    </div>

    <section id="matchesSection" class="glass-card p-4 mb-10 text-center">
        <h2 class="text-xl font-semibold mb-2 text-center">Partidos</h2>

        <div class="flex justify-center mb-2 space-x-2">
            <button id="generateSchedule" class="bg-blue-600 text-white rounded p-2">Generar Calendario</button>
            <button id="downloadPdf" class="bg-indigo-600 text-white rounded p-2">Calendario PDF</button>
        </div>

        <h3 class="text-lg font-semibold mb-2 mt-4 text-center">Calendario de Partidos</h3>
        <details>
            <summary class="font-semibold cursor-pointer">Ver calendario</summary>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm mt-2 responsive-table" id="historyTable">
                    <thead>
                        <tr class="border-b">
                            <th class="px-2 py-1">Fecha</th>
                            <th class="px-2 py-1">Cancha</th>
                            <th class="px-2 py-1">Horario</th>
                            <th class="px-2 py-1">Pareja A</th>
                            <th class="px-2 py-1">Pts A</th>
                            <th class="px-2 py-1">Pareja B</th>
                            <th class="px-2 py-1">Pts B</th>
                            <th class="px-2 py-1">Estado</th>
                            <th class="px-2 py-1"></th>
                        </tr>
                    </thead>
                    <tbody id="historyBody"></tbody>
                </table>
            </div>
        </details>

        <h3 class="text-lg font-semibold mb-2 mt-4 text-center">Partidos Finales</h3>
        <div id="eliminationBracket" class="space-y-2 text-sm"></div>
    </section>

    <section id="statsSection" class="glass-card p-4 mb-10 text-center">
        <h2 class="text-xl font-semibold mb-2 text-center">Estad√≠sticas</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-left">
                <thead>
                    <tr class="border-b">
                        <th class="px-2 py-1">Pareja</th>
                        <th class="px-2 py-1">JJ</th>
                        <th class="px-2 py-1">JG</th>
                        <th class="px-2 py-1">JP</th>
                        <th class="px-2 py-1">PF</th>
                        <th class="px-2 py-1">PC</th>
                    </tr>
                </thead>
                <tbody id="statsBody"></tbody>
            </table>
        </div>
    </section>

    <section id="resultsSection" class="glass-card p-4 mb-10 text-center">
        <h2 class="text-xl font-semibold mb-2 text-center">Resultados Finales</h2>
        <div id="finalResults" class="space-y-1 text-sm"></div>
    </section>

    <div class="flex justify-center mb-10 space-x-2">
        <button id="exportDBBtn" class="px-4 py-2 bg-green-600 text-white rounded">Exportar BD</button>
        <label for="importDBInput" class="px-4 py-2 bg-blue-600 text-white rounded cursor-pointer">Importar BD</label>
        <input type="file" id="importDBInput" accept=".json" class="hidden" />
    </div>

    <!-- Modals moved outside of glass-card sections to avoid backdrop-filter clipping -->
    <div id="playerModal" class="modal-overlay hidden">
        <div class="modal-window bg-white rounded-lg shadow-2xl p-4 w-80">
            <h3 class="text-lg font-semibold mb-2 text-center">Registro de Jugador</h3>
            <form id="playerForm" class="grid grid-cols-1 gap-2">
                <input id="playerName" placeholder="Nombre" class="border p-2 rounded" required />
                <input id="playerPhone" placeholder="Tel√©fono a 10 d√≠gitos" pattern="\d{10}" class="border p-2 rounded" required />
                <input id="playerAdscripcion" placeholder="Adscripci√≥n" class="border p-2 rounded" />
                <input id="playerTurno" placeholder="Turno" class="border p-2 rounded" />
                <input id="playerBase" placeholder="Tipo de base" class="border p-2 rounded" />
                <input id="playerTalla" placeholder="Talla de uniforme" class="border p-2 rounded" />
                <div class="flex justify-center space-x-2">
                    <button type="button" id="closePlayerModal" class="px-3 py-1 rounded border">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white rounded px-3 py-1">Registrar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="pairModal" class="modal-overlay hidden">
        <div class="modal-window bg-white rounded-lg shadow-2xl p-4 w-80">
            <h3 class="text-lg font-semibold mb-2 text-center">Registro de Pareja</h3>
            <form id="pairForm" class="grid grid-cols-1 gap-2">
                <select id="zagueroSelect" class="border p-2 rounded"></select>
                <select id="delanteroSelect" class="border p-2 rounded"></select>
                <div class="flex justify-center space-x-2">
                    <button type="button" id="closePairModal" class="px-3 py-1 rounded border">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white rounded px-3 py-1">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="matchModal" class="modal-overlay hidden">
        <div class="modal-window bg-white rounded-lg shadow-2xl p-4 w-80">
            <h3 class="text-lg font-semibold mb-2 text-center">Partido</h3>
            <form id="matchForm" class="space-y-3">
                <div class="grid grid-cols-1 gap-2">
                    <select id="categorySelect" class="border p-2 rounded">
                        <option value="Primera">Primera</option>
                        <option value="Segunda">Segunda</option>
                    </select>
                    <select id="daySelect" class="border p-2 rounded"></select>
                    <select id="courtSelect" class="border p-2 rounded">
                        <option value="">Cancha</option>
                        <option value="1">Cancha 1</option>
                        <option value="2">Cancha 2</option>
                    </select>
                    <select id="timeSelect" class="border p-2 rounded"></select>
                    <select id="statusSelect" class="border p-2 rounded">
                        <option value="Pendiente">Pendiente</option>
                        <option value="NoA">No Jugado - gana Pareja A</option>
                        <option value="NoB">No Jugado - gana Pareja B</option>
                    </select>
                </div>
                <hr>
                <div class="grid grid-cols-2 gap-2 items-center">
                    <select id="pairA" class="border p-2 rounded w-full"></select>
                    <input id="scoreA" type="number" min="0" class="border p-2 rounded" />
                </div>
                <hr>
                <div class="grid grid-cols-2 gap-2 items-center">
                    <select id="pairB" class="border p-2 rounded w-full"></select>
                    <input id="scoreB" type="number" min="0" class="border p-2 rounded" />
                </div>
                <div class="flex justify-center space-x-2">
                    <button type="button" id="closeMatchModal" class="px-3 py-1 rounded border">Cancelar</button>
                    <button type="submit" class="bg-green-600 text-white rounded px-3 py-1">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    </div>
    </div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
import { getFirestore, collection, addDoc, getDocs, onSnapshot, updateDoc, deleteDoc, doc, setDoc } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

// TODO: Reemplaza con la configuraci√≥n de tu proyecto Firebase
const firebaseConfig = {
    apiKey: "AIzaSyB1pgqjSN60z-QhdBenoEhbpkpLdY7WRyI",
    authDomain: "torneo2025.firebaseapp.com",
    projectId: "torneo2025",
    storageBucket: "torneo2025.appspot.com",
    messagingSenderId: "305813771068",
    appId: "1:305813771068:web:5c5b98ba8c26e5b35ec439",
    measurementId: "G-4X0726QEF8"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const pairForm = document.getElementById('pairForm');
const zagueroSelect = document.getElementById('zagueroSelect');
const delanteroSelect = document.getElementById('delanteroSelect');
const pairModal = document.getElementById('pairModal');
const openPairModalBtn = document.getElementById('openPairModal');
const closePairModalBtn = document.getElementById('closePairModal');
const pairList = document.getElementById('pairList');
const pairASelect = document.getElementById('pairA');
const pairBSelect = document.getElementById('pairB');
const matchForm = document.getElementById('matchForm');
const matchModal = document.getElementById('matchModal');
const openMatchModalBtn = document.getElementById('openMatchModal');
const closeMatchModalBtn = document.getElementById('closeMatchModal');
const statusSelect = document.getElementById('statusSelect');
const courtSelect = document.getElementById('courtSelect');
const timeSelect = document.getElementById('timeSelect');
const daySelect = document.getElementById('daySelect');
const categorySelect = document.getElementById('categorySelect');
const generateScheduleBtn = document.getElementById('generateSchedule');
const downloadPdfBtn = document.getElementById('downloadPdf');
const statsBody = document.getElementById('statsBody');
const historyBody = document.getElementById('historyBody');
const eliminationBracket = document.getElementById('eliminationBracket');
const playerForm = document.getElementById('playerForm');
const playerModal = document.getElementById('playerModal');
const openPlayerModalBtn = document.getElementById('openPlayerModal');
const closePlayerModalBtn = document.getElementById('closePlayerModal');
const playerList = document.getElementById('playerList');
const playerSearchInput = document.getElementById('playerSearch');
const clearPlayerSearch = document.getElementById('clearPlayerSearch');
const categoryTabs = document.querySelectorAll('[data-category]');
const pairSearchInput = document.getElementById('pairSearch');
const clearPairSearch = document.getElementById('clearPairSearch');

let currentCategory = 'Primera';

let currentPairs = [];
let currentMatches = [];
let currentPlayers = [];
let editingPairId = null;
let editingMatchId = null;
let editingPlayerId = null;

const availableDays = ['2025-09-09','2025-09-16','2025-09-23','2025-09-30'];
const courts = ['1','2'];
const timeSlots = [];
for (let h=16; h<20; h++) { timeSlots.push(`${h}:00`); timeSlots.push(`${h}:30`); }

function fillDayOptions() {
    daySelect.innerHTML = '<option value="">D√≠a</option>';
    availableDays.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = d;
        daySelect.appendChild(opt);
    });
}

openPlayerModalBtn.onclick = () => {
    playerForm.reset();
    playerModal.classList.remove('hidden');
};
closePlayerModalBtn.onclick = () => playerModal.classList.add('hidden');

playerSearchInput?.addEventListener('input', () => renderPlayers(currentPlayers));
clearPlayerSearch?.addEventListener('click', () => { playerSearchInput.value=''; renderPlayers(currentPlayers); });
pairSearchInput?.addEventListener('input', () => renderPairs(currentPairs.filter(p => p.category === currentCategory)));
clearPairSearch?.addEventListener('click', () => { pairSearchInput.value=''; renderPairs(currentPairs.filter(p => p.category === currentCategory)); });

courtSelect.onchange = fillTimeOptions;
daySelect.onchange = fillTimeOptions;
generateScheduleBtn.onclick = generateRoundRobin;
downloadPdfBtn.onclick = downloadSchedulePdf;

openPairModalBtn.onclick = () => {
    editingPairId = null;
    fillPlayerSelects();
    pairForm.reset();
    pairModal.classList.remove('hidden');
};
closePairModalBtn.onclick = () => pairModal.classList.add('hidden');

if (openMatchModalBtn) {
    openMatchModalBtn.onclick = () => {
        matchForm.reset();
        matchForm.dataset.stage = 'RR';
        editingMatchId = null;
        statusSelect.value = 'Pendiente';
        categorySelect.value = currentCategory;
        fillDayOptions();
        fillTimeOptions();
        matchModal.classList.remove('hidden');
    };
}
closeMatchModalBtn.onclick = () => {
    matchModal.classList.add('hidden');
    editingMatchId = null;
};

categoryTabs.forEach(t => {
    t.addEventListener('click', () => {
        currentCategory = t.dataset.category;
        updateTabStyles();
        refreshUI();
    });
});

function updateTabStyles() {
    categoryTabs.forEach(t => {
        if (t.dataset.category === currentCategory) {
            t.classList.add('bg-blue-600','text-white');
            t.classList.remove('bg-gray-200');
        } else {
            t.classList.remove('bg-blue-600','text-white');
            t.classList.add('bg-gray-200');
        }
    });
}

function fillPlayerSelects() {
    const used = new Set();
    currentPairs.forEach(p => {
        if (!editingPairId || p.id !== editingPairId) {
            used.add(p.zaguero);
            used.add(p.delantero);
        }
    });
    [zagueroSelect, delanteroSelect].forEach(sel => {
        sel.innerHTML = '<option value="">Jugador</option>';
        currentPlayers
            .filter(p => p.category === currentCategory && !used.has(p.name))
            .forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.textContent = p.name;
                sel.appendChild(opt);
            });
    });
}

function formatTime(t) {
    const [h,m] = t.split(':').map(Number);
    const hour = ((h + 11) % 12) + 1;
    const suf = h >= 12 ? 'PM' : 'AM';
    return `${hour}:${m.toString().padStart(2,'0')} ${suf}`;
}

function getShortName(name) {
    return name.split(/\s+/)[0];
}

function pairLabel(pair) {
    const zag = currentPlayers.find(pl => pl.name === pair.zaguero) || {};
    const del = currentPlayers.find(pl => pl.name === pair.delantero) || {};
    const sz = zag.shortName || getShortName(pair.zaguero);
    const sd = del.shortName || getShortName(pair.delantero);
    return `${sz} | ${sd}`;
}

function fillTimeOptions() {
    timeSelect.innerHTML = '<option value="">Horario</option>';
    const selectedCourt = courtSelect.value;
    const selectedDay = daySelect.value;
    const taken = currentMatches.filter(m => m.court === selectedCourt && m.day === selectedDay && (!editingMatchId || m.id !== editingMatchId)).map(m => m.time);
    timeSlots.forEach(t => {
        if (selectedCourt && selectedDay && taken.includes(t)) return;
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = formatTime(t);
        timeSelect.appendChild(opt);
    });
    if (editingMatchId) {
        const match = currentMatches.find(m => m.id === editingMatchId);
        if (match && match.court === selectedCourt && match.day === selectedDay && !timeSlots.includes(match.time)) {
            const opt = document.createElement('option');
            opt.value = match.time;
            opt.textContent = formatTime(match.time);
            timeSelect.appendChild(opt);
        }
    }
}

function refreshUI() {
    const pairs = currentPairs.filter(p => p.category === currentCategory);
    const matches = currentMatches.filter(m => m.category === currentCategory);
    renderPairs(pairs);
    renderStats(computeStats(pairs, matches.filter(m => (m.stage || 'RR') === 'RR')));
    renderHistory(pairs, matches);
    maybeGenerateFinals(pairs, matches);
    renderElimination(pairs, matches);
    renderFinalResults(pairs, matches);
    fillDayOptions();
    fillTimeOptions();
}

playerForm.onsubmit = async e => {
    e.preventDefault();
    const phoneDigits = document.getElementById('playerPhone').value.replace(/\D/g, '');
    const formattedPhone = phoneDigits.length === 10 ?
        `(${phoneDigits.slice(0,3)}) ${phoneDigits.slice(3,6)} ${phoneDigits.slice(6)}` : phoneDigits;
    const fullName = document.getElementById('playerName').value.trim();
    const data = {
        name: fullName,
        shortName: getShortName(fullName),
        category: currentCategory,
        phone: formattedPhone,
        adscripcion: document.getElementById('playerAdscripcion').value.trim(),
        turno: document.getElementById('playerTurno').value.trim(),
        base: document.getElementById('playerBase').value.trim(),
        talla: document.getElementById('playerTalla').value.trim()
    };
    if (!data.name) return;
    if (editingPlayerId) {
        await updateDoc(doc(db, 'players', editingPlayerId), data);
        editingPlayerId = null;
    } else {
        await addDoc(collection(db, 'players'), data);
    }
    playerForm.reset();
    playerModal.classList.add('hidden');
};

pairForm.onsubmit = async e => {
    e.preventDefault();
    const zaguero = zagueroSelect.value;
    const delantero = delanteroSelect.value;
    if (!zaguero || !delantero) return;
    const data = { zaguero, delantero, category: currentCategory };
    if (editingPairId) {
        await updateDoc(doc(db, 'pairs', editingPairId), data);
        editingPairId = null;
    } else {
        await addDoc(collection(db, 'pairs'), data);
    }
    pairForm.reset();
    pairModal.classList.add('hidden');
};

matchForm.onsubmit = async e => {
    e.preventDefault();
    const pairA = pairASelect.value;
    const pairB = pairBSelect.value;
    const day = daySelect.value;
    const court = courtSelect.value;
    const time = timeSelect.value;
    const category = categorySelect.value || currentCategory;
    let scoreA = parseInt(document.getElementById('scoreA').value) || 0;
    let scoreB = parseInt(document.getElementById('scoreB').value) || 0;
    if (!pairA || !pairB || pairA === pairB || !court || !time || !day) return;
    const conflict = currentMatches.some(m => m.court === court && m.day === day && m.time === time && m.id !== editingMatchId);
    if (conflict) { alert('Horario no disponible'); return; }
    const stage = matchForm.dataset.stage || 'RR';
    let status = statusSelect.value;
    if (status === 'NoA') { status = 'No Jugado'; scoreA = 1; scoreB = 0; }
    else if (status === 'NoB') { status = 'No Jugado'; scoreA = 0; scoreB = 1; }
    else if (scoreA !== 0 || scoreB !== 0) { status = 'Finalizado'; }
    else { status = 'Pendiente'; }
    const data = { pairA, pairB, scoreA, scoreB, stage, category, court, time, day, ts: Date.now(), status };
    if (editingMatchId) {
        await updateDoc(doc(db, 'matches', editingMatchId), data);
        editingMatchId = null;
    } else {
        await addDoc(collection(db, 'matches'), data);
    }
    matchForm.reset();
    statusSelect.value = 'Pendiente';
    fillTimeOptions();
    matchModal.classList.add('hidden');
};

function renderPairs(pairs) {
    pairList.innerHTML = '';
    pairASelect.innerHTML = '<option value="">Pareja A</option>';
    pairBSelect.innerHTML = '<option value="">Pareja B</option>';
    const query = (document.getElementById('pairSearch')?.value || '').toLowerCase();
    pairs.forEach(p => {
        const optA = document.createElement('option');
        optA.value = p.id;
        optA.textContent = pairLabel(p);
        pairASelect.appendChild(optA);
        pairBSelect.appendChild(optA.cloneNode(true));

        const zag = currentPlayers.find(pl => pl.name === p.zaguero) || {};
        const del = currentPlayers.find(pl => pl.name === p.delantero) || {};
        const text = `${p.zaguero} ${p.delantero} ${zag.adscripcion || ''} ${zag.turno || ''} ${del.adscripcion || ''} ${del.turno || ''}`.toLowerCase();
        if (!query || text.includes(query)) {
            const tr = document.createElement('tr');
            tr.className = 'border-b';
            tr.innerHTML = `
                <td class="px-2 py-1" data-label="Zaguero">${p.zaguero}</td>
                <td class="px-2 py-1" data-label="Delantero">${p.delantero}</td>
                <td class="px-2 py-1" data-label="Categor√≠a">${p.category || ''}</td>
                <td class="px-2 py-1 whitespace-nowrap" data-label="Acciones">
                    <button data-edit="${p.id}" class="text-blue-600"><i class="ti ti-pencil"></i></button>
                    <button data-del="${p.id}" class="text-red-600 ml-2"><i class="ti ti-trash"></i></button>
                </td>`;
            pairList.appendChild(tr);
        }
    });
}

function renderPlayers(players) {
    const query = (document.getElementById('playerSearch')?.value || '').toLowerCase();
    playerList.innerHTML = '';
    players.forEach(p => {
        const text = `${p.name} ${p.adscripcion || ''} ${p.turno || ''}`.toLowerCase();
        if (!query || text.includes(query)) {
            const tr = document.createElement('tr');
            tr.className = 'border-b';
            tr.innerHTML = `
                <td class="px-2 py-1" data-label="Nombre">${p.name}</td>
                <td class="px-2 py-1" data-label="Categor√≠a">${p.category}</td>
                <td class="px-2 py-1 whitespace-nowrap" data-label="Acciones">
                    <button data-edit="${p.id}" class="text-blue-600"><i class="ti ti-pencil"></i></button>
                    <button data-del="${p.id}" class="text-red-600 ml-2"><i class="ti ti-trash"></i></button>
                </td>`;
            playerList.appendChild(tr);
        }
    });
}

pairList.onclick = async e => {
    if (e.target.closest('button')?.dataset.edit) {
        const id = e.target.closest('button').dataset.edit;
        const pair = currentPairs.find(p => p.id === id);
        if (pair) {
            editingPairId = id;
            fillPlayerSelects();
            zagueroSelect.value = pair.zaguero;
            delanteroSelect.value = pair.delantero;
            pairModal.classList.remove('hidden');
        }
    } else if (e.target.closest('button')?.dataset.del) {
        const id = e.target.closest('button').dataset.del;
        if (confirm('Eliminar pareja?')) {
            await deleteDoc(doc(db, 'pairs', id));
        }
    }
};

playerList.onclick = async e => {
    if (e.target.closest('button')?.dataset.edit) {
        const id = e.target.closest('button').dataset.edit;
        const player = currentPlayers.find(p => p.id === id);
        if (player) {
            document.getElementById('playerName').value = player.name;
            document.getElementById('playerPhone').value = player.phone.replace(/\D/g, '');
            document.getElementById('playerAdscripcion').value = player.adscripcion;
            document.getElementById('playerTurno').value = player.turno;
            document.getElementById('playerBase').value = player.base;
            document.getElementById('playerTalla').value = player.talla;
            editingPlayerId = id;
            playerModal.classList.remove('hidden');
        }
    } else if (e.target.closest('button')?.dataset.del) {
        const id = e.target.closest('button').dataset.del;
        if (confirm('Eliminar jugador?')) {
            await deleteDoc(doc(db, 'players', id));
        }
    }
};

function computeStats(pairs, matches) {
    const stats = {};
    pairs.forEach(p => stats[p.id] = { id: p.id, name: pairLabel(p), jj:0, jg:0, jp:0, pf:0, pc:0 });
    matches.forEach(m => {
        const a = stats[m.pairA];
        const b = stats[m.pairB];
        if (!a || !b) return;
        const st = m.status || ((m.scoreA || m.scoreB) ? 'Finalizado' : 'Pendiente');
        if (st === 'Finalizado' || st === 'No Jugado') {
            a.jj++; b.jj++;
            a.pf += m.scoreA; a.pc += m.scoreB;
            b.pf += m.scoreB; b.pc += m.scoreA;
            if (m.scoreA > m.scoreB) { a.jg++; b.jp++; }
            else if (m.scoreB > m.scoreA) { b.jg++; a.jp++; }
        }
    });
    return Object.values(stats);
}

async function maybeGenerateFinals(pairs, matches) {
    const rrMatches = matches.filter(m => (m.stage || 'RR') === 'RR');
    const finalExists = matches.some(m => m.stage === 'F');
    const thirdExists = matches.some(m => m.stage === '3P');
    const expected = pairs.length * (pairs.length - 1) / 2;
    if (finalExists && thirdExists) return;
    if (rrMatches.length < expected || pairs.length < 4) return;
    const stats = computeStats(pairs, rrMatches);
    stats.sort((a,b) => b.jg - a.jg || (b.pf - b.pc) - (a.pf - a.pc));
    const top4 = stats.slice(0,4);
    if (top4.length < 4) return;
    const pad = n => n.toString().padStart(2,'0');
    const fmt = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const last = new Date(availableDays[availableDays.length-1]);
    last.setDate(last.getDate()+7);
    const day = fmt(last);
    const ts = Date.now();
    if (!finalExists) {
        await addDoc(collection(db,'matches'), {pairA:top4[0].id, pairB:top4[1].id, day, court:courts[0], time:timeSlots[0], scoreA:0, scoreB:0, stage:'F', match:'F', category:currentCategory, ts, status:'Pendiente'});
    }
    if (!thirdExists) {
        await addDoc(collection(db,'matches'), {pairA:top4[2].id, pairB:top4[3].id, day, court:courts[1]||courts[0], time:timeSlots[0], scoreA:0, scoreB:0, stage:'3P', match:'3P', category:currentCategory, ts, status:'Pendiente'});
    }
}


function renderStats(stats) {
    stats.sort((a,b) => b.jg - a.jg || (b.pf - b.pc) - (a.pf - a.pc));
    statsBody.innerHTML = '';
    stats.forEach(s => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="px-2 py-1" data-label="Pareja">${s.name}</td>
            <td data-label="JJ">${s.jj}</td>
            <td data-label="JG">${s.jg}</td>
            <td data-label="JP">${s.jp}</td>
            <td data-label="PF">${s.pf}</td>
            <td data-label="PC">${s.pc}</td>`;
        statsBody.appendChild(tr);
    });
}

function renderHistory(pairs, matches) {
    const map = Object.fromEntries(pairs.map(p => [p.id, pairLabel(p)]));
    historyBody.innerHTML = '';
    matches.sort((a,b) => {
        if (a.day !== b.day) return (a.day||'').localeCompare(b.day||'');
        if (a.court !== b.court) return (a.court||0) - (b.court||0);
        return (a.time||'').localeCompare(b.time||'');
    });
    matches.forEach(m => {
        const tr = document.createElement('tr');
        tr.className = 'border-b';
        const st = m.status || ((m.scoreA || m.scoreB) ? 'Finalizado' : 'Pendiente');
        tr.innerHTML = `
            <td class="px-2 py-1" data-label="Fecha">${m.day || ''}</td>
            <td class="px-2 py-1" data-label="Cancha">${m.court || ''}</td>
            <td class="px-2 py-1" data-label="Horario">${m.time ? formatTime(m.time) : ''}</td>
            <td class="px-2 py-1" data-label="Pareja A">${map[m.pairA] || '?'}</td>
            <td class="px-2 py-1 text-center" data-label="Pts A">${m.scoreA}</td>
            <td class="px-2 py-1" data-label="Pareja B">${map[m.pairB] || '?'}</td>
            <td class="px-2 py-1 text-center" data-label="Pts B">${m.scoreB}</td>
            <td class="px-2 py-1" data-label="Estado">${st}</td>
            <td class="px-2 py-1 whitespace-nowrap" data-label="Acciones">
                <button data-edit="${m.id}" class="text-blue-600"><i class="ti ti-pencil"></i></button>
                <button data-del="${m.id}" class="text-red-600 ml-2"><i class="ti ti-trash"></i></button>
            </td>`;
        historyBody.appendChild(tr);
    });
}

historyBody.onclick = async e => {
    if (e.target.closest('button')?.dataset.edit) {
        const id = e.target.closest('button').dataset.edit;
        const match = currentMatches.find(m => m.id === id);
        if (match) {
            pairASelect.value = match.pairA;
            pairBSelect.value = match.pairB;
            document.getElementById('scoreA').value = match.scoreA;
            document.getElementById('scoreB').value = match.scoreB;
            categorySelect.value = match.category || currentCategory;
            daySelect.value = match.day || '';
            courtSelect.value = match.court || '';
            editingMatchId = id;
            fillTimeOptions();
            timeSelect.value = match.time || '';
            if (match.status === 'No Jugado') {
                if (match.scoreA === 1 && match.scoreB === 0) statusSelect.value = 'NoA';
                else if (match.scoreB === 1 && match.scoreA === 0) statusSelect.value = 'NoB';
                else statusSelect.value = 'Pendiente';
            } else {
                statusSelect.value = match.status || 'Pendiente';
            }
            matchForm.dataset.stage = match.stage || 'RR';
            matchModal.classList.remove('hidden');
        }
    } else if (e.target.closest('button')?.dataset.del) {
        const id = e.target.closest('button').dataset.del;
        if (confirm('Eliminar partido?')) {
            await deleteDoc(doc(db, 'matches', id));
        }
    }
};

function renderElimination(pairs, matches) {
    const rrMatches = matches.filter(m => (m.stage || 'RR') === 'RR');
    const rrDone = rrMatches.every(m => m.status === "Finalizado" || m.status === "No Jugado");
    const stats = computeStats(pairs, rrMatches);
    stats.sort((a,b) => b.jg - a.jg || (b.pf - b.pc) - (a.pf - a.pc));
    const top4 = stats.slice(0,4);
    const map = Object.fromEntries(pairs.map(p => [p.id, pairLabel(p)]));
    const finalMatch = matches.find(m => m.stage === 'F');
    const thirdMatch = matches.find(m => m.stage === '3P');

    eliminationBracket.innerHTML = '';
    if (top4.length < 4) {
        eliminationBracket.textContent = 'Esperando resultados de ronda inicial.';
        return;
    }

    const createForm = (aId, bId, stage, existing) => {
        const form = document.createElement('form');
        form.className = 'space-y-2';
        form.dataset.stage = stage;
        const nameA = rrDone ? map[aId] : 'Pendiente de Resultados';
        const nameB = rrDone ? map[bId] : 'Pendiente de Resultados';
        const disabled = rrDone ? '' : 'disabled';
        form.innerHTML = `
            <div class="grid grid-cols-2 gap-2 items-center">
                <span>${nameA}</span>
                <input class="border p-2 rounded" name="sa" type="number" min="0" ${disabled} />
            </div>
            <div class="text-center font-semibold">vs</div>
            <div class="grid grid-cols-2 gap-2 items-center">
                <span>${nameB}</span>
                <input class="border p-2 rounded" name="sb" type="number" min="0" ${disabled} />
            </div>
            <input type="hidden" name="a" value="${aId}">
            <input type="hidden" name="b" value="${bId}">
            <div class="flex justify-center">
                <button type="submit" class="bg-green-600 text-white rounded p-2" ${disabled}>Guardar</button>
            </div>`;
        const inputA = form.querySelector('input[name="sa"]');
        const inputB = form.querySelector('input[name="sb"]');
        if (existing) {
            inputA.value = existing.scoreA;
            inputB.value = existing.scoreB;
        }
        form.onsubmit = async ev => {
            ev.preventDefault();
            const scoreA = parseInt(inputA.value)||0;
            const scoreB = parseInt(inputB.value)||0;
            const pairA = aId;
            const pairB = bId;
            const data = { pairA, pairB, scoreA, scoreB, stage, ts:Date.now(), status:'Finalizado' };
            if (existing) {
                await updateDoc(doc(db,'matches', existing.id), data);
            } else {
                await addDoc(collection(db,'matches'), data);
            }
            form.reset();
        };
        return form;
    };

    const finalCard = document.createElement('details');
    finalCard.className = 'glass-card p-4 mb-4';
    const finalSum = document.createElement('summary');
    finalSum.className = 'font-semibold cursor-pointer';
    finalSum.textContent = 'Final';
    finalCard.appendChild(finalSum);
    finalCard.appendChild(createForm(top4[0].id, top4[1].id, 'F', finalMatch));

    const thirdCard = document.createElement('details');
    thirdCard.className = 'glass-card p-4 mb-4';
    const thirdSum = document.createElement('summary');
    thirdSum.className = 'font-semibold cursor-pointer';
    thirdSum.textContent = 'Tercer Lugar';
    thirdCard.appendChild(thirdSum);
    thirdCard.appendChild(createForm(top4[2].id, top4[3].id, '3P', thirdMatch));

    eliminationBracket.appendChild(finalCard);
    eliminationBracket.appendChild(thirdCard);
}

function renderFinalResults(pairs, matches) {
    const container = document.getElementById('finalResults');
    const map = Object.fromEntries(pairs.map(p => [p.id, pairLabel(p)]));
    const finalMatch = matches.find(m => m.stage === 'F');
    const thirdMatch = matches.find(m => m.stage === '3P');
    const rrDone = matches.filter(m => (m.stage || 'RR') === 'RR').every(m => m.status === 'Finalizado' || m.status === 'No Jugado');
    container.innerHTML = '';
    if (!finalMatch || !thirdMatch || finalMatch.status !== 'Finalizado' || thirdMatch.status !== 'Finalizado' || !rrDone) {
        container.textContent = 'Pendiente de resultados';
        return;
    }
    const first = finalMatch.scoreA > finalMatch.scoreB ? finalMatch.pairA : finalMatch.pairB;
    const second = finalMatch.scoreA > finalMatch.scoreB ? finalMatch.pairB : finalMatch.pairA;
    const third = thirdMatch.scoreA > thirdMatch.scoreB ? thirdMatch.pairA : thirdMatch.pairB;
    [{label:'Primer Lugar', id:first}, {label:'Segundo Lugar', id:second}, {label:'Tercer Lugar', id:third}].forEach(r => {
        const div = document.createElement('div');
        div.textContent = `${r.label}: ${map[r.id] || '?'}`;
        container.appendChild(div);
    });
}

async function loadData() {
    const pairSnap = await getDocs(collection(db, 'pairs'));
    const pairs = pairSnap.docs.map(d => ({ id: d.id, ...d.data() }));
    const matchSnap = await getDocs(collection(db, 'matches'));
    const matches = matchSnap.docs.map(d => ({ id: d.id, ...d.data() }));
    const playerSnap = await getDocs(collection(db, 'players'));
    const players = playerSnap.docs.map(d => {
        const obj = { id: d.id, ...d.data() };
        obj.shortName = obj.shortName || getShortName(obj.name || '');
        return obj;
    });
    currentPairs = pairs;
    currentMatches = matches;
    currentPlayers = players;
    renderPlayers(players);
    refreshUI();
}

async function generateRoundRobin() {
    const categories = Array.from(new Set(currentPairs.map(p => p.category)));
    const existing = currentMatches.filter(m => (m.stage || 'RR') === 'RR');
    if (existing.length && !confirm('Ya existe un rol. ¬øDeseas reemplazarlo?')) return;
    for (const m of existing) { await deleteDoc(doc(db, 'matches', m.id)); }

    let unscheduled = [];
    categories.forEach(cat => {
        const pairs = currentPairs.filter(p => p.category === cat);
        if (pairs.length < 2) return;
        let ids = pairs.map(p => p.id);
        if (ids.length % 2 === 1) ids.push(null);
        const numRounds = ids.length - 1;
        const half = ids.length / 2;
        let arr = ids.slice();
        for (let r=0; r<numRounds; r++) {
            for (let i=0; i<half; i++) {
                const a = arr[i];
                const b = arr[arr.length - 1 - i];
                if (a && b) unscheduled.push({ pairA: a, pairB: b, category: cat });
            }
            arr.splice(1, 0, arr.pop());
        }
    });

    const totalSlotsPerDay = courts.length * timeSlots.length;
    unscheduled.forEach((m, idx) => {
        const day = availableDays[Math.floor(idx / totalSlotsPerDay) % availableDays.length];
        const slot = idx % totalSlotsPerDay;
        const court = courts[slot % courts.length];
        const time = timeSlots[Math.floor(slot / courts.length)];
        Object.assign(m, { day, court, time, scoreA: 0, scoreB: 0, stage: 'RR', ts: Date.now(), status:'Pendiente' });
    });

    for (const m of unscheduled) { await addDoc(collection(db, 'matches'), m); }
    alert('Rol generado');
}

function downloadSchedulePdf() {
    const map = Object.fromEntries(currentPairs.map(p => [p.id, pairLabel(p)]));
    const cats = Array.from(new Set(currentMatches.map(m => m.category)));
    const win = window.open('', '_blank');
    if (!win) return;
    let html = `<html><head><title>Calendario</title><style>
        @page { size: landscape; margin: 1cm; }
        body{font-family:sans-serif;}table{border-collapse:collapse;width:100%;}
        th,td{border:1px solid #000;padding:4px;}th{background:#eee;}
        .page{page-break-before:always;padding-bottom:20px;}
        h1,h2{margin-top:0;margin-bottom:0.5rem;}
    </style></head><body>`;
    cats.forEach((cat, ci) => {
        const matchesCat = currentMatches.filter(m => m.category === cat).sort((a,b) => {
            if (a.day !== b.day) return (a.day||'').localeCompare(b.day||'');
            if (a.court !== b.court) return (a.court||0) - (b.court||0);
            return (a.time||'').localeCompare(b.time||'');
        });
        const days = Array.from(new Set(matchesCat.map(m => m.day))).sort();
        days.forEach((day, di) => {
            const matches = matchesCat.filter(m => m.day === day);
            if (!matches.length) return;
            const pageClass = (ci || di) ? 'page' : '';
            html += `<div class="${pageClass}">`;
            html += `<h1>Categor√≠a ${cat}</h1><h2>${day}</h2>`;
            html += `<table><thead><tr><th>Cancha</th><th>Horario</th><th>Pareja A</th><th>Pts. A</th><th>Pareja B</th><th>Pts. B</th></tr></thead><tbody>`;
            matches.forEach(m => {
                html += `<tr><td>${m.court || ''}</td><td>${formatTime(m.time || '')}</td><td>${map[m.pairA] || ''}</td><td>${m.scoreA}</td><td>${map[m.pairB] || ''}</td><td>${m.scoreB}</td></tr>`;
            });
            html += '</tbody></table></div>';
        });
    });
    html += '</body></html>';
    win.document.write(html);
    win.document.close();
    win.print();
}

async function exportDatabase() {
    const [pairSnap, matchSnap, playerSnap] = await Promise.all([
        getDocs(collection(db, 'pairs')),
        getDocs(collection(db, 'matches')),
        getDocs(collection(db, 'players'))
    ]);
    const data = {
        pairs: pairSnap.docs.map(d => ({ id: d.id, ...d.data() })),
        matches: matchSnap.docs.map(d => ({ id: d.id, ...d.data() })),
        players: playerSnap.docs.map(d => ({ id: d.id, ...d.data() }))
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'torneo-datos.json';
    a.click();
    URL.revokeObjectURL(url);
}

async function importDatabase(file) {
    const text = await file.text();
    const data = JSON.parse(text);
    if (data.players) {
        for (const p of data.players) {
            if (!p.shortName && p.name) p.shortName = getShortName(p.name);
            await setDoc(doc(db, 'players', p.id), p);
        }
    }
    if (data.pairs) {
        for (const p of data.pairs) {
            await setDoc(doc(db, 'pairs', p.id), p);
        }
    }
    if (data.matches) {
        for (const m of data.matches) {
            await setDoc(doc(db, 'matches', m.id), m);
        }
    }
    alert('Datos importados correctamente');
}

document.getElementById('exportDBBtn').addEventListener('click', exportDatabase);
document.getElementById('importDBInput').addEventListener('change', e => {
    if (e.target.files[0]) {
        importDatabase(e.target.files[0]);
    }
});

onSnapshot(collection(db, 'pairs'), loadData);
onSnapshot(collection(db, 'matches'), loadData);
onSnapshot(collection(db, 'players'), loadData);
updateTabStyles();
loadData();
</script>
<script>
  (function(){
    const PASSWORD = 'frontenis2025';
    const overlay = document.getElementById('passwordOverlay');
    const main = document.getElementById('mainContent');
    const input = document.getElementById('passwordInput');
    function check() {
        if (input.value === PASSWORD) {
            overlay.remove();
            main.classList.remove('hidden');
        } else {
            document.getElementById('passwordError').classList.remove('hidden');
        }
    }
    document.getElementById('passwordSubmit').addEventListener('click', check);
    input.addEventListener('keypress', e => { if (e.key === 'Enter') check(); });
  })();
</script>
</body>
</html>
