<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torneo de Frontenis ISSEA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.47.0/tabler-icons.min.css">
    <style>
        .glass-card {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(6px);
            border-radius: 1rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="bg-gray-50 p-4 max-w-2xl mx-auto">
    <h1 class="text-2xl font-bold text-center mb-6">Administrador Torneo Frontenis ISSEA</h1>
    <div class="flex justify-center mb-6 space-x-2">
        <button id="tabPrimera" data-category="Primera" class="px-4 py-2 bg-blue-600 text-white rounded">Primera</button>
        <button id="tabSegunda" data-category="Segunda" class="px-4 py-2 bg-gray-200 rounded">Segunda</button>
    </div>

    <div class="flex justify-center mb-6 space-x-2">
        <button id="exportDBBtn" class="px-4 py-2 bg-green-600 text-white rounded">Exportar BD</button>
        <label for="importDBInput" class="px-4 py-2 bg-blue-600 text-white rounded cursor-pointer">Importar BD</label>
        <input type="file" id="importDBInput" accept=".json" class="hidden" />
    </div>

    <section id="infoSection" class="glass-card p-4 mb-10">
        <h2 class="text-xl font-semibold mb-2">Información del Torneo</h2>
        <p class="mb-2">El torneo se llevará a cabo en el <strong>Deportivo IV Centenario</strong> de Aguascalientes.</p>
        <p class="mb-2">Las jornadas serán los <strong>miércoles</strong> del <strong>9/09/2025</strong> al <strong>30/09/2025</strong>.</p>
        <p class="mb-2">Habrá dos categorías: <strong>Primera</strong> y <strong>Segunda</strong>. Cada jugador solo puede inscribirse en una categoría.</p>
        <p>Las instalaciones cuentan con <strong>2 canchas de Frontenis</strong>.</p>
    </section>

    <section id="playerSection" class="glass-card p-4 mb-10">
        <h2 class="text-xl font-semibold mb-2">Cédula de Jugador</h2>
        <button id="openPlayerModal" class="bg-blue-600 text-white rounded p-2 mb-2">Añadir Jugador</button>
        <div id="playerModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-60">
            <div class="bg-white rounded-lg shadow-2xl p-4 w-80">
                <h3 class="text-lg font-semibold mb-2">Registro de Jugador</h3>
                <form id="playerForm" class="grid grid-cols-1 gap-2">
                    <input id="playerName" placeholder="Nombre" class="border p-2 rounded" required />
                    <input id="playerPhone" placeholder="Teléfono a 10 dígitos" pattern="\d{10}" class="border p-2 rounded" required />
                    <input id="playerAdscripcion" placeholder="Adscripción" class="border p-2 rounded" />
                    <input id="playerTurno" placeholder="Turno" class="border p-2 rounded" />
                    <input id="playerBase" placeholder="Tipo de base" class="border p-2 rounded" />
                    <input id="playerTalla" placeholder="Talla de uniforme" class="border p-2 rounded" />
                    <div class="flex justify-end space-x-2">
                        <button type="button" id="closePlayerModal" class="px-3 py-1 rounded border">Cancelar</button>
                        <button type="submit" class="bg-blue-600 text-white rounded px-3 py-1">Registrar</button>
                    </div>
                </form>
            </div>
        </div>
        <details class="mt-4">
            <summary class="font-semibold cursor-pointer">Listado de Jugadores</summary>
            <div class="flex items-center mt-2">
                <input id="playerSearch" type="text" placeholder="Buscar..." class="border p-2 rounded w-full" />
                <button id="clearPlayerSearch" type="button" class="ml-2 px-2 py-1 bg-gray-200 rounded">✕</button>
            </div>
            <ul id="playerList" class="mt-2 space-y-1 text-sm"></ul>
        </details>
    </section>

    <section id="pairSection" class="glass-card p-4 mb-10">
        <h2 class="text-xl font-semibold mb-2">Agregar Pareja</h2>
        <button id="openPairModal" class="bg-blue-500 text-white rounded p-2 mb-2">Añadir Pareja</button>
        <div id="pairModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-60">
            <div class="bg-white rounded-lg shadow-2xl p-4 w-80">
                <h3 class="text-lg font-semibold mb-2">Registro de Pareja</h3>
                <form id="pairForm" class="grid grid-cols-1 gap-2">
                    <select id="zagueroSelect" class="border p-2 rounded"></select>
                    <select id="delanteroSelect" class="border p-2 rounded"></select>
                    <div class="flex justify-end space-x-2">
                        <button type="button" id="closePairModal" class="px-3 py-1 rounded border">Cancelar</button>
                        <button type="submit" class="bg-blue-600 text-white rounded px-3 py-1">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
        <details class="mt-4">
            <summary class="font-semibold cursor-pointer">Listado de Parejas</summary>
            <div class="flex items-center mt-2">
                <input id="pairSearch" type="text" placeholder="Buscar..." class="border p-2 rounded w-full" />
                <button id="clearPairSearch" type="button" class="ml-2 px-2 py-1 bg-gray-200 rounded">✕</button>
            </div>
            <ul id="pairList" class="mt-2 space-y-1 text-sm"></ul>
        </details>
    </section>

    <section id="matchesSection" class="glass-card p-4 mb-10">
        <h2 class="text-xl font-semibold mb-2">Partidos</h2>

        <h3 class="text-lg font-semibold mb-2">Eliminatorias</h3>
        <div id="eliminationBracket" class="space-y-2 text-sm mb-4"></div>

        <h3 class="text-lg font-semibold mb-2">Registrar Partido</h3>
        <div class="mb-2 space-x-2">
            <button id="generateSchedule" class="bg-blue-600 text-white rounded p-2">Generar Calendario</button>
            <button id="downloadPdf" class="bg-indigo-600 text-white rounded p-2">Calendario PDF</button>
            <button id="openMatchModal" class="bg-green-600 text-white rounded p-2">Registrar Partido</button>
        </div>
        <div id="matchModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-60">
            <div class="bg-white rounded-lg shadow-2xl p-4 w-80">
                <h3 class="text-lg font-semibold mb-2">Registro de Partido</h3>
                <form id="matchForm" class="space-y-3">
                    <div class="grid grid-cols-3 gap-2">
                        <select id="daySelect" class="border p-2 rounded"></select>
                        <select id="timeSelect" class="border p-2 rounded"></select>
                        <select id="courtSelect" class="border p-2 rounded">
                            <option value="">Cancha</option>
                            <option value="1">Cancha 1</option>
                            <option value="2">Cancha 2</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-6 gap-2 items-center">
                        <select id="pairA" class="border p-2 rounded col-span-2"></select>
                        <input id="scoreA" type="number" min="0" class="border p-2 rounded" />
                        <span class="text-center">vs</span>
                        <input id="scoreB" type="number" min="0" class="border p-2 rounded" />
                        <select id="pairB" class="border p-2 rounded col-span-2"></select>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" id="closeMatchModal" class="px-3 py-1 rounded border">Cancelar</button>
                        <button type="submit" class="bg-green-600 text-white rounded px-3 py-1">Guardar</button>
                    </div>
                </form>
            </div>
        </div>

        <h3 class="text-lg font-semibold mb-2 mt-4">Historial de Partidos</h3>
        <details>
            <summary class="font-semibold cursor-pointer">Ver Historial</summary>
            <ul id="historyList" class="space-y-1 text-sm mt-2"></ul>
        </details>
    </section>

    <section id="statsSection" class="glass-card p-4 mb-10">
        <h2 class="text-xl font-semibold mb-2">Estadísticas</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-left">
                <thead>
                    <tr class="border-b">
                        <th class="px-2 py-1">Pareja</th>
                        <th class="px-2 py-1">JJ</th>
                        <th class="px-2 py-1">JG</th>
                        <th class="px-2 py-1">JP</th>
                        <th class="px-2 py-1">PF</th>
                        <th class="px-2 py-1">PC</th>
                    </tr>
                </thead>
                <tbody id="statsBody"></tbody>
            </table>
        </div>
    </section>

    <section id="resultsSection" class="glass-card p-4 mb-10">
        <h2 class="text-xl font-semibold mb-2">Resultados Finales</h2>
        <div id="finalResults" class="space-y-1 text-sm"></div>
    </section>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
import { getFirestore, collection, addDoc, getDocs, onSnapshot, updateDoc, deleteDoc, doc, setDoc } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

// TODO: Reemplaza con la configuración de tu proyecto Firebase
const firebaseConfig = {
    apiKey: "AIzaSyB1pgqjSN60z-QhdBenoEhbpkpLdY7WRyI",
    authDomain: "torneo2025.firebaseapp.com",
    projectId: "torneo2025",
    storageBucket: "torneo2025.appspot.com",
    messagingSenderId: "305813771068",
    appId: "1:305813771068:web:5c5b98ba8c26e5b35ec439",
    measurementId: "G-4X0726QEF8"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const pairForm = document.getElementById('pairForm');
const zagueroSelect = document.getElementById('zagueroSelect');
const delanteroSelect = document.getElementById('delanteroSelect');
const pairModal = document.getElementById('pairModal');
const openPairModalBtn = document.getElementById('openPairModal');
const closePairModalBtn = document.getElementById('closePairModal');
const pairList = document.getElementById('pairList');
const pairASelect = document.getElementById('pairA');
const pairBSelect = document.getElementById('pairB');
const matchForm = document.getElementById('matchForm');
const matchModal = document.getElementById('matchModal');
const openMatchModalBtn = document.getElementById('openMatchModal');
const closeMatchModalBtn = document.getElementById('closeMatchModal');
const courtSelect = document.getElementById('courtSelect');
const timeSelect = document.getElementById('timeSelect');
const daySelect = document.getElementById('daySelect');
const generateScheduleBtn = document.getElementById('generateSchedule');
const downloadPdfBtn = document.getElementById('downloadPdf');
const statsBody = document.getElementById('statsBody');
const historyList = document.getElementById('historyList');
const eliminationBracket = document.getElementById('eliminationBracket');
const playerForm = document.getElementById('playerForm');
const playerModal = document.getElementById('playerModal');
const openPlayerModalBtn = document.getElementById('openPlayerModal');
const closePlayerModalBtn = document.getElementById('closePlayerModal');
const playerList = document.getElementById('playerList');
const playerSearchInput = document.getElementById('playerSearch');
const clearPlayerSearch = document.getElementById('clearPlayerSearch');
const categoryTabs = document.querySelectorAll('[data-category]');
const pairSearchInput = document.getElementById('pairSearch');
const clearPairSearch = document.getElementById('clearPairSearch');

let currentCategory = 'Primera';

let currentPairs = [];
let currentMatches = [];
let currentPlayers = [];
let editingPairId = null;
let editingMatchId = null;
let editingPlayerId = null;

const availableDays = ['2025-09-09','2025-09-16','2025-09-23','2025-09-30'];
const courts = ['1','2'];
const timeSlots = [];
for (let h=16; h<20; h++) { timeSlots.push(`${h}:00`); timeSlots.push(`${h}:30`); }

function fillDayOptions() {
    daySelect.innerHTML = '<option value="">Día</option>';
    availableDays.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = d;
        daySelect.appendChild(opt);
    });
}

openPlayerModalBtn.onclick = () => {
    playerForm.reset();
    playerModal.classList.remove('hidden');
};
closePlayerModalBtn.onclick = () => playerModal.classList.add('hidden');

playerSearchInput?.addEventListener('input', () => renderPlayers(currentPlayers));
clearPlayerSearch?.addEventListener('click', () => { playerSearchInput.value=''; renderPlayers(currentPlayers); });
pairSearchInput?.addEventListener('input', () => renderPairs(currentPairs.filter(p => p.category === currentCategory)));
clearPairSearch?.addEventListener('click', () => { pairSearchInput.value=''; renderPairs(currentPairs.filter(p => p.category === currentCategory)); });

courtSelect.onchange = fillTimeOptions;
daySelect.onchange = fillTimeOptions;
generateScheduleBtn.onclick = generateRoundRobin;
downloadPdfBtn.onclick = downloadSchedulePdf;

openPairModalBtn.onclick = () => {
    editingPairId = null;
    fillPlayerSelects();
    pairForm.reset();
    pairModal.classList.remove('hidden');
};
closePairModalBtn.onclick = () => pairModal.classList.add('hidden');

openMatchModalBtn.onclick = () => {
    matchForm.reset();
    matchForm.dataset.stage = 'RR';
    editingMatchId = null;
    fillDayOptions();
    fillTimeOptions();
    matchModal.classList.remove('hidden');
};
closeMatchModalBtn.onclick = () => {
    matchModal.classList.add('hidden');
    editingMatchId = null;
};

categoryTabs.forEach(t => {
    t.addEventListener('click', () => {
        currentCategory = t.dataset.category;
        updateTabStyles();
        refreshUI();
    });
});

function updateTabStyles() {
    categoryTabs.forEach(t => {
        if (t.dataset.category === currentCategory) {
            t.classList.add('bg-blue-600','text-white');
            t.classList.remove('bg-gray-200');
        } else {
            t.classList.remove('bg-blue-600','text-white');
            t.classList.add('bg-gray-200');
        }
    });
}

function fillPlayerSelects() {
    const used = new Set();
    currentPairs.forEach(p => {
        if (!editingPairId || p.id !== editingPairId) {
            used.add(p.zaguero);
            used.add(p.delantero);
        }
    });
    [zagueroSelect, delanteroSelect].forEach(sel => {
        sel.innerHTML = '<option value="">Jugador</option>';
        currentPlayers
            .filter(p => p.category === currentCategory && !used.has(p.name))
            .forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.textContent = p.name;
                sel.appendChild(opt);
            });
    });
}

function formatTime(t) {
    const [h,m] = t.split(':').map(Number);
    const hour = ((h + 11) % 12) + 1;
    const suf = h >= 12 ? 'PM' : 'AM';
    return `${hour}:${m.toString().padStart(2,'0')} ${suf}`;
}

function fillTimeOptions() {
    timeSelect.innerHTML = '<option value="">Horario</option>';
    const selectedCourt = courtSelect.value;
    const selectedDay = daySelect.value;
    const taken = currentMatches.filter(m => m.court === selectedCourt && m.day === selectedDay && (!editingMatchId || m.id !== editingMatchId)).map(m => m.time);
    timeSlots.forEach(t => {
        if (selectedCourt && selectedDay && taken.includes(t)) return;
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = formatTime(t);
        timeSelect.appendChild(opt);
    });
    if (editingMatchId) {
        const match = currentMatches.find(m => m.id === editingMatchId);
        if (match && match.court === selectedCourt && match.day === selectedDay && !timeSlots.includes(match.time)) {
            const opt = document.createElement('option');
            opt.value = match.time;
            opt.textContent = formatTime(match.time);
            timeSelect.appendChild(opt);
        }
    }
}

function refreshUI() {
    const pairs = currentPairs.filter(p => p.category === currentCategory);
    const matches = currentMatches.filter(m => m.category === currentCategory);
    renderPairs(pairs);
    renderStats(computeStats(pairs, matches.filter(m => (m.stage || 'RR') === 'RR')));
    renderHistory(pairs, matches);
    maybeGenerateFinals(pairs, matches);
    renderElimination(pairs, matches);
    renderFinalResults(pairs, matches);
    fillDayOptions();
    fillTimeOptions();
}

playerForm.onsubmit = async e => {
    e.preventDefault();
    const phoneDigits = document.getElementById('playerPhone').value.replace(/\D/g, '');
    const formattedPhone = phoneDigits.length === 10 ?
        `(${phoneDigits.slice(0,3)}) ${phoneDigits.slice(3,6)} ${phoneDigits.slice(6)}` : phoneDigits;
    const data = {
        name: document.getElementById('playerName').value.trim(),
        category: currentCategory,
        phone: formattedPhone,
        adscripcion: document.getElementById('playerAdscripcion').value.trim(),
        turno: document.getElementById('playerTurno').value.trim(),
        base: document.getElementById('playerBase').value.trim(),
        talla: document.getElementById('playerTalla').value.trim()
    };
    if (!data.name) return;
    if (editingPlayerId) {
        await updateDoc(doc(db, 'players', editingPlayerId), data);
        editingPlayerId = null;
    } else {
        await addDoc(collection(db, 'players'), data);
    }
    playerForm.reset();
    playerModal.classList.add('hidden');
};

pairForm.onsubmit = async e => {
    e.preventDefault();
    const zaguero = zagueroSelect.value;
    const delantero = delanteroSelect.value;
    if (!zaguero || !delantero) return;
    const data = { zaguero, delantero, category: currentCategory };
    if (editingPairId) {
        await updateDoc(doc(db, 'pairs', editingPairId), data);
        editingPairId = null;
    } else {
        await addDoc(collection(db, 'pairs'), data);
    }
    pairForm.reset();
    pairModal.classList.add('hidden');
};

matchForm.onsubmit = async e => {
    e.preventDefault();
    const pairA = pairASelect.value;
    const pairB = pairBSelect.value;
    const day = daySelect.value;
    const court = courtSelect.value;
    const time = timeSelect.value;
    const scoreA = parseInt(document.getElementById('scoreA').value) || 0;
    const scoreB = parseInt(document.getElementById('scoreB').value) || 0;
    if (!pairA || !pairB || pairA === pairB || !court || !time || !day) return;
    const conflict = currentMatches.some(m => m.court === court && m.day === day && m.time === time && m.id !== editingMatchId);
    if (conflict) { alert('Horario no disponible'); return; }
    const stage = matchForm.dataset.stage || 'RR';
    const data = { pairA, pairB, scoreA, scoreB, stage, category: currentCategory, court, time, day, ts: Date.now() };
    if (editingMatchId) {
        await updateDoc(doc(db, 'matches', editingMatchId), data);
        editingMatchId = null;
    } else {
        await addDoc(collection(db, 'matches'), data);
    }
    matchForm.reset();
    fillTimeOptions();
    matchModal.classList.add('hidden');
};

function renderPairs(pairs) {
    pairList.innerHTML = '';
    pairASelect.innerHTML = '<option value="">Pareja A</option>';
    pairBSelect.innerHTML = '<option value="">Pareja B</option>';
    const query = (document.getElementById('pairSearch')?.value || '').toLowerCase();
    pairs.forEach(p => {
        const optA = document.createElement('option');
        optA.value = p.id;
        optA.textContent = `${p.zaguero} / ${p.delantero}`;
        pairASelect.appendChild(optA);
        pairBSelect.appendChild(optA.cloneNode(true));

        const zag = currentPlayers.find(pl => pl.name === p.zaguero) || {};
        const del = currentPlayers.find(pl => pl.name === p.delantero) || {};
        const text = `${p.zaguero} ${p.delantero} ${zag.adscripcion || ''} ${zag.turno || ''} ${del.adscripcion || ''} ${del.turno || ''}`.toLowerCase();
        if (!query || text.includes(query)) {
            const li = document.createElement('li');
            li.innerHTML = `${p.zaguero} / ${p.delantero} <button data-edit="${p.id}" class="text-blue-600"><i class="ti ti-pencil"></i></button> <button data-del="${p.id}" class="text-red-600"><i class="ti ti-trash"></i></button>`;
            pairList.appendChild(li);
        }
    });
}

function renderPlayers(players) {
    const query = (document.getElementById('playerSearch')?.value || '').toLowerCase();
    playerList.innerHTML = '';
    players.forEach(p => {
        const text = `${p.name} ${p.adscripcion || ''} ${p.turno || ''}`.toLowerCase();
        if (!query || text.includes(query)) {
            const li = document.createElement('li');
            li.innerHTML = `${p.name} (${p.category}) <button data-edit="${p.id}" class="text-blue-600"><i class="ti ti-pencil"></i></button> <button data-del="${p.id}" class="text-red-600"><i class="ti ti-trash"></i></button>`;
            playerList.appendChild(li);
        }
    });
}

pairList.onclick = async e => {
    if (e.target.closest('button')?.dataset.edit) {
        const id = e.target.closest('button').dataset.edit;
        const pair = currentPairs.find(p => p.id === id);
        if (pair) {
            editingPairId = id;
            fillPlayerSelects();
            zagueroSelect.value = pair.zaguero;
            delanteroSelect.value = pair.delantero;
            pairModal.classList.remove('hidden');
        }
    } else if (e.target.closest('button')?.dataset.del) {
        const id = e.target.closest('button').dataset.del;
        if (confirm('Eliminar pareja?')) {
            await deleteDoc(doc(db, 'pairs', id));
        }
    }
};

playerList.onclick = async e => {
    if (e.target.closest('button')?.dataset.edit) {
        const id = e.target.closest('button').dataset.edit;
        const player = currentPlayers.find(p => p.id === id);
        if (player) {
            document.getElementById('playerName').value = player.name;
            document.getElementById('playerPhone').value = player.phone.replace(/\D/g, '');
            document.getElementById('playerAdscripcion').value = player.adscripcion;
            document.getElementById('playerTurno').value = player.turno;
            document.getElementById('playerBase').value = player.base;
            document.getElementById('playerTalla').value = player.talla;
            editingPlayerId = id;
            playerModal.classList.remove('hidden');
        }
    } else if (e.target.closest('button')?.dataset.del) {
        const id = e.target.closest('button').dataset.del;
        if (confirm('Eliminar jugador?')) {
            await deleteDoc(doc(db, 'players', id));
        }
    }
};

function computeStats(pairs, matches) {
    const stats = {};
    pairs.forEach(p => stats[p.id] = { id: p.id, name: `${p.zaguero} / ${p.delantero}`, jj:0, jg:0, jp:0, pf:0, pc:0 });
    matches.forEach(m => {
        const a = stats[m.pairA];
        const b = stats[m.pairB];
        if (!a || !b) return;
        a.jj++; b.jj++;
        a.pf += m.scoreA; a.pc += m.scoreB;
        b.pf += m.scoreB; b.pc += m.scoreA;
        if (m.scoreA > m.scoreB) { a.jg++; b.jp++; }
        else if (m.scoreB > m.scoreA) { b.jg++; a.jp++; }
    });
    return Object.values(stats);
}

async function maybeGenerateFinals(pairs, matches) {
    const rrMatches = matches.filter(m => (m.stage || 'RR') === 'RR');
    const finalExists = matches.some(m => m.stage === 'F');
    const thirdExists = matches.some(m => m.stage === '3P');
    const expected = pairs.length * (pairs.length - 1) / 2;
    if (finalExists && thirdExists) return;
    if (rrMatches.length < expected || pairs.length < 4) return;
    const stats = computeStats(pairs, rrMatches);
    stats.sort((a,b) => b.jg - a.jg || (b.pf - b.pc) - (a.pf - a.pc));
    const top4 = stats.slice(0,4);
    if (top4.length < 4) return;
    const pad = n => n.toString().padStart(2,'0');
    const fmt = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const last = new Date(availableDays[availableDays.length-1]);
    last.setDate(last.getDate()+7);
    const day = fmt(last);
    const ts = Date.now();
    if (!finalExists) {
        await addDoc(collection(db,'matches'), {pairA:top4[0].id, pairB:top4[1].id, day, court:courts[0], time:timeSlots[0], scoreA:0, scoreB:0, stage:'F', match:'F', category:currentCategory, ts});
    }
    if (!thirdExists) {
        await addDoc(collection(db,'matches'), {pairA:top4[2].id, pairB:top4[3].id, day, court:courts[1]||courts[0], time:timeSlots[0], scoreA:0, scoreB:0, stage:'3P', match:'3P', category:currentCategory, ts});
    }
}


function renderStats(stats) {
    stats.sort((a,b) => b.jg - a.jg || (b.pf - b.pc) - (a.pf - a.pc));
    statsBody.innerHTML = '';
    stats.forEach(s => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="px-2 py-1">${s.name}</td><td>${s.jj}</td><td>${s.jg}</td><td>${s.jp}</td><td>${s.pf}</td><td>${s.pc}</td>`;
        statsBody.appendChild(tr);
    });
}

function renderHistory(pairs, matches) {
    const map = Object.fromEntries(pairs.map(p => [p.id, `${p.zaguero} / ${p.delantero}`]));
    historyList.innerHTML = '';
    matches.sort((a,b) => {
        if (a.day !== b.day) return (a.day||'').localeCompare(b.day||'');
        if (a.court !== b.court) return (a.court||0) - (b.court||0);
        return (a.time||'').localeCompare(b.time||'');
    });
    let current = '';
    matches.forEach(m => {
        const group = `${m.day || '?'} C${m.court || '?'} ${m.time ? formatTime(m.time) : ''}`;
        if (group !== current) {
            const header = document.createElement('li');
            header.className = 'font-semibold mt-2';
            header.textContent = group;
            historyList.appendChild(header);
            current = group;
        }
        const stage = m.stage || 'RR';
        const li = document.createElement('li');
        li.className = 'ml-4';
        li.innerHTML = `${stage}: ${map[m.pairA] || '?'} ${m.scoreA}-${m.scoreB} ${map[m.pairB] || '?'} <button data-edit="${m.id}" class="text-blue-600"><i class="ti ti-pencil"></i></button> <button data-del="${m.id}" class="text-red-600"><i class="ti ti-trash"></i></button>`;
        historyList.appendChild(li);
    });
}

historyList.onclick = async e => {
    if (e.target.closest('button')?.dataset.edit) {
        const id = e.target.closest('button').dataset.edit;
        const match = currentMatches.find(m => m.id === id);
        if (match) {
            pairASelect.value = match.pairA;
            pairBSelect.value = match.pairB;
            document.getElementById('scoreA').value = match.scoreA;
            document.getElementById('scoreB').value = match.scoreB;
            daySelect.value = match.day || '';
            courtSelect.value = match.court || '';
            fillTimeOptions();
            timeSelect.value = match.time || '';
            matchForm.dataset.stage = match.stage || 'RR';
            editingMatchId = id;
            matchModal.classList.remove('hidden');
        }
    } else if (e.target.closest('button')?.dataset.del) {
        const id = e.target.closest('button').dataset.del;
        if (confirm('Eliminar partido?')) {
            await deleteDoc(doc(db, 'matches', id));
        }
    }
};

function renderElimination(pairs, matches) {
    const rrMatches = matches.filter(m => (m.stage || 'RR') === 'RR');
    const stats = computeStats(pairs, rrMatches);
    stats.sort((a,b) => b.jg - a.jg || (b.pf - b.pc) - (a.pf - a.pc));
    const top4 = stats.slice(0,4);
    const map = Object.fromEntries(pairs.map(p => [p.id, `${p.zaguero} / ${p.delantero}`]));
    const finalMatch = matches.find(m => m.stage === 'F');
    const thirdMatch = matches.find(m => m.stage === '3P');

    eliminationBracket.innerHTML = '';
    if (top4.length < 4) {
        eliminationBracket.textContent = 'Esperando resultados de ronda inicial.';
        return;
    }

    const createForm = (aId, bId, stage, existing) => {
        const form = document.createElement('form');
        form.className = 'space-y-2';
        form.dataset.stage = stage;
        form.innerHTML = `
            <div class="grid grid-cols-2 gap-2 items-center">
                <span>${map[aId]}</span>
                <input class="border p-2 rounded" name="sa" type="number" min="0" />
            </div>
            <div class="text-center font-semibold">vs</div>
            <div class="grid grid-cols-2 gap-2 items-center">
                <span>${map[bId]}</span>
                <input class="border p-2 rounded" name="sb" type="number" min="0" />
            </div>
            <input type="hidden" name="a" value="${aId}">
            <input type="hidden" name="b" value="${bId}">
            <div class="flex justify-end">
                <button type="submit" class="bg-green-600 text-white rounded p-2">Guardar</button>
            </div>`;
        const inputA = form.querySelector('input[name="sa"]');
        const inputB = form.querySelector('input[name="sb"]');
        if (existing) {
            inputA.value = existing.scoreA;
            inputB.value = existing.scoreB;
        }
        form.onsubmit = async ev => {
            ev.preventDefault();
            const scoreA = parseInt(inputA.value)||0;
            const scoreB = parseInt(inputB.value)||0;
            const pairA = aId;
            const pairB = bId;
            const data = { pairA, pairB, scoreA, scoreB, stage, ts:Date.now() };
            if (existing) {
                await updateDoc(doc(db,'matches', existing.id), data);
            } else {
                await addDoc(collection(db,'matches'), data);
            }
            form.reset();
        };
        return form;
    };

    const finalCard = document.createElement('details');
    finalCard.className = 'glass-card p-4 mb-4';
    const finalSum = document.createElement('summary');
    finalSum.className = 'font-semibold cursor-pointer';
    finalSum.textContent = 'Final';
    finalCard.appendChild(finalSum);
    finalCard.appendChild(createForm(top4[0].id, top4[1].id, 'F', finalMatch));

    const thirdCard = document.createElement('details');
    thirdCard.className = 'glass-card p-4 mb-4';
    const thirdSum = document.createElement('summary');
    thirdSum.className = 'font-semibold cursor-pointer';
    thirdSum.textContent = 'Tercer Lugar';
    thirdCard.appendChild(thirdSum);
    thirdCard.appendChild(createForm(top4[2].id, top4[3].id, '3P', thirdMatch));

    eliminationBracket.appendChild(finalCard);
    eliminationBracket.appendChild(thirdCard);
}

function renderFinalResults(pairs, matches) {
    const container = document.getElementById('finalResults');
    const map = Object.fromEntries(pairs.map(p => [p.id, `${p.zaguero} / ${p.delantero}`]));
    const finalMatch = matches.find(m => m.stage === 'F');
    const thirdMatch = matches.find(m => m.stage === '3P');
    container.innerHTML = '';
    if (!finalMatch || !thirdMatch) {
        container.textContent = 'Resultados pendientes';
        return;
    }
    const first = finalMatch.scoreA > finalMatch.scoreB ? finalMatch.pairA : finalMatch.pairB;
    const second = finalMatch.scoreA > finalMatch.scoreB ? finalMatch.pairB : finalMatch.pairA;
    const third = thirdMatch.scoreA > thirdMatch.scoreB ? thirdMatch.pairA : thirdMatch.pairB;
    [{label:'Primer Lugar', id:first}, {label:'Segundo Lugar', id:second}, {label:'Tercer Lugar', id:third}].forEach(r => {
        const div = document.createElement('div');
        div.textContent = `${r.label}: ${map[r.id] || '?'}`;
        container.appendChild(div);
    });
}

async function loadData() {
    const pairSnap = await getDocs(collection(db, 'pairs'));
    const pairs = pairSnap.docs.map(d => ({ id: d.id, ...d.data() }));
    const matchSnap = await getDocs(collection(db, 'matches'));
    const matches = matchSnap.docs.map(d => ({ id: d.id, ...d.data() }));
    const playerSnap = await getDocs(collection(db, 'players'));
    const players = playerSnap.docs.map(d => ({ id: d.id, ...d.data() }));
    currentPairs = pairs;
    currentMatches = matches;
    currentPlayers = players;
    renderPlayers(players);
    refreshUI();
}

async function generateRoundRobin() {
    const categories = Array.from(new Set(currentPairs.map(p => p.category)));
    const existing = currentMatches.filter(m => (m.stage || 'RR') === 'RR');
    if (existing.length && !confirm('Ya existe un rol. ¿Deseas reemplazarlo?')) return;
    for (const m of existing) { await deleteDoc(doc(db, 'matches', m.id)); }

    let unscheduled = [];
    categories.forEach(cat => {
        const pairs = currentPairs.filter(p => p.category === cat);
        if (pairs.length < 2) return;
        let ids = pairs.map(p => p.id);
        if (ids.length % 2 === 1) ids.push(null);
        const numRounds = ids.length - 1;
        const half = ids.length / 2;
        let arr = ids.slice();
        for (let r=0; r<numRounds; r++) {
            for (let i=0; i<half; i++) {
                const a = arr[i];
                const b = arr[arr.length - 1 - i];
                if (a && b) unscheduled.push({ pairA: a, pairB: b, category: cat });
            }
            arr.splice(1, 0, arr.pop());
        }
    });

    const totalSlotsPerDay = courts.length * timeSlots.length;
    unscheduled.forEach((m, idx) => {
        const day = availableDays[Math.floor(idx / totalSlotsPerDay) % availableDays.length];
        const slot = idx % totalSlotsPerDay;
        const court = courts[slot % courts.length];
        const time = timeSlots[Math.floor(slot / courts.length)];
        Object.assign(m, { day, court, time, scoreA: 0, scoreB: 0, stage: 'RR', ts: Date.now() });
    });

    for (const m of unscheduled) { await addDoc(collection(db, 'matches'), m); }
    alert('Rol generado');
}

function downloadSchedulePdf() {
    const map = Object.fromEntries(currentPairs.map(p => [p.id, `${p.zaguero} / ${p.delantero}`]));
    const cats = Array.from(new Set(currentMatches.map(m => m.category)));
    const win = window.open('', '_blank');
    if (!win) return;
    let html = `<html><head><title>Calendario</title><style>
        body{font-family:sans-serif;}table{border-collapse:collapse;width:100%;margin-bottom:20px;}
        th,td{border:1px solid #000;padding:4px;}th{background:#eee;}h1,h2{margin-top:1.5rem;}
    </style></head><body>`;
    cats.forEach(cat => {
        const matches = currentMatches.filter(m => m.category === cat).sort((a,b) => {
            if (a.day !== b.day) return (a.day||'').localeCompare(b.day||'');
            if (a.court !== b.court) return (a.court||0) - (b.court||0);
            return (a.time||'').localeCompare(b.time||'');
        });
        if (!matches.length) return;
        html += `<h1>Categoría ${cat}</h1>`;
        let current = '';
        matches.forEach(m => {
            if (m.day !== current) {
                if (current) html += '</tbody></table>';
                html += `<h2>${m.day}</h2><table><thead><tr><th>Cancha</th><th>Horario</th><th>Pareja A</th><th>Pareja B</th><th>Marcador</th></tr></thead><tbody>`;
                current = m.day;
            }
            html += `<tr><td>${m.court || ''}</td><td>${formatTime(m.time || '')}</td><td>${map[m.pairA] || ''}</td><td>${map[m.pairB] || ''}</td><td style="height:20px"></td></tr>`;
        });
        if (current) html += '</tbody></table>';
    });
    html += '</body></html>';
    win.document.write(html);
    win.document.close();
    win.print();
}

async function exportDatabase() {
    const [pairSnap, matchSnap, playerSnap] = await Promise.all([
        getDocs(collection(db, 'pairs')),
        getDocs(collection(db, 'matches')),
        getDocs(collection(db, 'players'))
    ]);
    const data = {
        pairs: pairSnap.docs.map(d => ({ id: d.id, ...d.data() })),
        matches: matchSnap.docs.map(d => ({ id: d.id, ...d.data() })),
        players: playerSnap.docs.map(d => ({ id: d.id, ...d.data() }))
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'torneo-datos.json';
    a.click();
    URL.revokeObjectURL(url);
}

async function importDatabase(file) {
    const text = await file.text();
    const data = JSON.parse(text);
    if (data.players) {
        for (const p of data.players) {
            await setDoc(doc(db, 'players', p.id), p);
        }
    }
    if (data.pairs) {
        for (const p of data.pairs) {
            await setDoc(doc(db, 'pairs', p.id), p);
        }
    }
    if (data.matches) {
        for (const m of data.matches) {
            await setDoc(doc(db, 'matches', m.id), m);
        }
    }
    alert('Datos importados correctamente');
}

document.getElementById('exportDBBtn').addEventListener('click', exportDatabase);
document.getElementById('importDBInput').addEventListener('change', e => {
    if (e.target.files[0]) {
        importDatabase(e.target.files[0]);
    }
});

onSnapshot(collection(db, 'pairs'), loadData);
onSnapshot(collection(db, 'matches'), loadData);
onSnapshot(collection(db, 'players'), loadData);
updateTabStyles();
loadData();
</script>
</body>
</html>
