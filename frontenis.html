<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torneo de Frontenis ISSEA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.47.0/tabler-icons.min.css">
</head>
<body class="bg-gray-50 p-4 max-w-2xl mx-auto">
    <h1 class="text-2xl font-bold text-center mb-6">Administrador Torneo Frontenis ISSEA</h1>

    <section id="infoSection" class="mb-10">
        <h2 class="text-xl font-semibold mb-2">Información del Torneo</h2>
        <p class="mb-2">El torneo se llevará a cabo en el <strong>Deportivo IV Centenario</strong> de Aguascalientes.</p>
        <p class="mb-2">Las jornadas serán los <strong>miércoles</strong> del <strong>9/09/2025</strong> al <strong>30/09/2025</strong>.</p>
        <p class="mb-2">Habrá dos categorías: <strong>Primera</strong> y <strong>Segunda</strong>. Cada jugador solo puede inscribirse en una categoría.</p>
        <p>Las instalaciones cuentan con <strong>2 canchas de Frontenis</strong>.</p>
    </section>

    <section id="playerSection" class="mb-10">
        <h2 class="text-xl font-semibold mb-2">Cédula de Jugador</h2>
        <form id="playerForm" class="grid grid-cols-1 gap-2">
            <input id="playerName" placeholder="Nombre" class="border p-2 rounded" required />
            <select id="playerCategory" class="border p-2 rounded" required>
                <option value="">Categoría</option>
                <option value="Primera">Primera</option>
                <option value="Segunda">Segunda</option>
            </select>
            <input id="playerPhone" placeholder="Teléfono (XXX) XXX XXXX" pattern="\(\d{3}\) \d{3} \d{4}" class="border p-2 rounded" required />
            <input id="playerAdscripcion" placeholder="Adscripción" class="border p-2 rounded" />
            <input id="playerTurno" placeholder="Turno" class="border p-2 rounded" />
            <input id="playerBase" placeholder="Tipo de base" class="border p-2 rounded" />
            <input id="playerTalla" placeholder="Talla de uniforme" class="border p-2 rounded" />
            <button type="submit" class="bg-blue-600 text-white rounded p-2">Registrar</button>
        </form>
        <ul id="playerList" class="mt-4 space-y-1 text-sm"></ul>
    </section>

    <section id="pairSection" class="mb-10">
        <h2 class="text-xl font-semibold mb-2">Agregar Pareja</h2>
        <form id="pairForm" class="grid grid-cols-1 gap-2 sm:grid-cols-3 sm:gap-4">
            <input id="zagueroName" placeholder="Zaguero" class="border p-2 rounded" />
            <input id="delanteroName" placeholder="Delantero" class="border p-2 rounded" />
            <button type="submit" class="bg-blue-500 text-white rounded p-2">Agregar</button>
        </form>
        <ul id="pairList" class="mt-4 space-y-1 text-sm"></ul>
    </section>

    <section id="historySection" class="mb-10">
        <h2 class="text-xl font-semibold mb-2">Historial de Partidos</h2>
        <ul id="historyList" class="space-y-1 text-sm"></ul>
    </section>

    <section id="eliminationSection" class="mb-10">
        <h2 class="text-xl font-semibold mb-2">Eliminatorias</h2>
        <div id="eliminationBracket" class="space-y-2 text-sm"></div>
    </section>

    <section id="matchSection" class="mb-10">
        <h2 class="text-xl font-semibold mb-2">Registrar Partido</h2>
        <form id="matchForm" class="grid grid-cols-2 gap-2 items-center">
            <select id="pairA" class="border p-2 rounded"></select>
            <input id="scoreA" type="number" min="0" class="border p-2 rounded" />
            <span class="col-span-2 text-center">vs</span>
            <select id="pairB" class="border p-2 rounded"></select>
            <input id="scoreB" type="number" min="0" class="border p-2 rounded" />
            <button type="submit" class="bg-green-600 text-white rounded p-2 col-span-2">Registrar</button>
        </form>
    </section>

    <section id="statsSection" class="mb-10">
        <h2 class="text-xl font-semibold mb-2">Estadísticas</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-left">
                <thead>
                    <tr class="border-b">
                        <th class="px-2 py-1">Pareja</th>
                        <th class="px-2 py-1">JJ</th>
                        <th class="px-2 py-1">JG</th>
                        <th class="px-2 py-1">JP</th>
                        <th class="px-2 py-1">PF</th>
                        <th class="px-2 py-1">PC</th>
                    </tr>
                </thead>
                <tbody id="statsBody"></tbody>
            </table>
        </div>
    </section>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
import { getFirestore, collection, addDoc, getDocs, onSnapshot, updateDoc, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

// TODO: Reemplaza con la configuración de tu proyecto Firebase
const firebaseConfig = {
    apiKey: "AIzaSyB1pgqjSN60z-QhdBenoEhbpkpLdY7WRyI",
    authDomain: "torneo2025.firebaseapp.com",
    projectId: "torneo2025",
    storageBucket: "torneo2025.appspot.com",
    messagingSenderId: "305813771068",
    appId: "1:305813771068:web:5c5b98ba8c26e5b35ec439",
    measurementId: "G-4X0726QEF8"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const pairForm = document.getElementById('pairForm');
const zagueroInput = document.getElementById('zagueroName');
const delanteroInput = document.getElementById('delanteroName');
const pairList = document.getElementById('pairList');
const pairASelect = document.getElementById('pairA');
const pairBSelect = document.getElementById('pairB');
const matchForm = document.getElementById('matchForm');
const statsBody = document.getElementById('statsBody');
const historyList = document.getElementById('historyList');
const eliminationBracket = document.getElementById('eliminationBracket');
const playerForm = document.getElementById('playerForm');
const playerList = document.getElementById('playerList');

let currentPairs = [];
let currentMatches = [];
let currentPlayers = [];
let editingPairId = null;
let editingMatchId = null;
let editingPlayerId = null;

playerForm.onsubmit = async e => {
    e.preventDefault();
    const data = {
        name: document.getElementById('playerName').value.trim(),
        category: document.getElementById('playerCategory').value,
        phone: document.getElementById('playerPhone').value.trim(),
        adscripcion: document.getElementById('playerAdscripcion').value.trim(),
        turno: document.getElementById('playerTurno').value.trim(),
        base: document.getElementById('playerBase').value.trim(),
        talla: document.getElementById('playerTalla').value.trim()
    };
    if (!data.name || !data.category) return;
    if (editingPlayerId) {
        await updateDoc(doc(db, 'players', editingPlayerId), data);
        editingPlayerId = null;
    } else {
        await addDoc(collection(db, 'players'), data);
    }
    playerForm.reset();
};

pairForm.onsubmit = async e => {
    e.preventDefault();
    const zaguero = zagueroInput.value.trim();
    const delantero = delanteroInput.value.trim();
    if (!zaguero || !delantero) return;
    if (editingPairId) {
        await updateDoc(doc(db, 'pairs', editingPairId), { zaguero, delantero });
        editingPairId = null;
    } else {
        await addDoc(collection(db, 'pairs'), { zaguero, delantero });
    }
    pairForm.reset();
};

matchForm.onsubmit = async e => {
    e.preventDefault();
    const pairA = pairASelect.value;
    const pairB = pairBSelect.value;
    const scoreA = parseInt(document.getElementById('scoreA').value) || 0;
    const scoreB = parseInt(document.getElementById('scoreB').value) || 0;
    if (!pairA || !pairB || pairA === pairB) return;
    const stage = matchForm.dataset.stage || 'RR';
    if (editingMatchId) {
        await updateDoc(doc(db, 'matches', editingMatchId), { pairA, pairB, scoreA, scoreB, stage });
        editingMatchId = null;
    } else {
        await addDoc(collection(db, 'matches'), { pairA, pairB, scoreA, scoreB, stage, ts: Date.now() });
    }
    matchForm.reset();
};

function renderPairs(pairs) {
    pairList.innerHTML = '';
    pairASelect.innerHTML = '<option value="">Pareja A</option>';
    pairBSelect.innerHTML = '<option value="">Pareja B</option>';
    pairs.forEach(p => {
        const li = document.createElement('li');
        li.innerHTML = `${p.zaguero} / ${p.delantero} <button data-edit="${p.id}" class="text-blue-600"><i class="ti ti-pencil"></i></button> <button data-del="${p.id}" class="text-red-600"><i class="ti ti-trash"></i></button>`;
        pairList.appendChild(li);

        const optA = document.createElement('option');
        optA.value = p.id;
        optA.textContent = `${p.zaguero} / ${p.delantero}`;
        pairASelect.appendChild(optA);
        const optB = optA.cloneNode(true);
        pairBSelect.appendChild(optB);
    });
}

function renderPlayers(players) {
    playerList.innerHTML = '';
    players.forEach(p => {
        const li = document.createElement('li');
        li.innerHTML = `${p.name} (${p.category}) <button data-edit="${p.id}" class="text-blue-600"><i class="ti ti-pencil"></i></button> <button data-del="${p.id}" class="text-red-600"><i class="ti ti-trash"></i></button>`;
        playerList.appendChild(li);
    });
}

pairList.onclick = async e => {
    if (e.target.dataset.edit) {
        const id = e.target.dataset.edit;
        const pair = currentPairs.find(p => p.id === id);
        if (pair) {
            zagueroInput.value = pair.zaguero;
            delanteroInput.value = pair.delantero;
            editingPairId = id;
        }
    } else if (e.target.dataset.del) {
        const id = e.target.dataset.del;
        if (confirm('Eliminar pareja?')) {
            await deleteDoc(doc(db, 'pairs', id));
        }
    }
};

playerList.onclick = async e => {
    if (e.target.closest('button')?.dataset.edit) {
        const id = e.target.closest('button').dataset.edit;
        const player = currentPlayers.find(p => p.id === id);
        if (player) {
            document.getElementById('playerName').value = player.name;
            document.getElementById('playerCategory').value = player.category;
            document.getElementById('playerPhone').value = player.phone;
            document.getElementById('playerAdscripcion').value = player.adscripcion;
            document.getElementById('playerTurno').value = player.turno;
            document.getElementById('playerBase').value = player.base;
            document.getElementById('playerTalla').value = player.talla;
            editingPlayerId = id;
        }
    } else if (e.target.closest('button')?.dataset.del) {
        const id = e.target.closest('button').dataset.del;
        if (confirm('Eliminar jugador?')) {
            await deleteDoc(doc(db, 'players', id));
        }
    }
};

function computeStats(pairs, matches) {
    const stats = {};
    pairs.forEach(p => stats[p.id] = { id: p.id, name: `${p.zaguero} / ${p.delantero}`, jj:0, jg:0, jp:0, pf:0, pc:0 });
    matches.forEach(m => {
        const a = stats[m.pairA];
        const b = stats[m.pairB];
        if (!a || !b) return;
        a.jj++; b.jj++;
        a.pf += m.scoreA; a.pc += m.scoreB;
        b.pf += m.scoreB; b.pc += m.scoreA;
        if (m.scoreA > m.scoreB) { a.jg++; b.jp++; }
        else if (m.scoreB > m.scoreA) { b.jg++; a.jp++; }
    });
    return Object.values(stats);
}

function renderStats(stats) {
    statsBody.innerHTML = '';
    stats.forEach(s => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="px-2 py-1">${s.name}</td><td>${s.jj}</td><td>${s.jg}</td><td>${s.jp}</td><td>${s.pf}</td><td>${s.pc}</td>`;
        statsBody.appendChild(tr);
    });
}

function renderHistory(pairs, matches) {
    const map = Object.fromEntries(pairs.map(p => [p.id, `${p.zaguero} / ${p.delantero}`]));
    historyList.innerHTML = '';
    matches.sort((a,b) => a.ts - b.ts);
    matches.forEach(m => {
        const stage = m.stage || 'RR';
        const li = document.createElement('li');
        li.innerHTML = `${stage}: ${map[m.pairA] || '?'} ${m.scoreA}-${m.scoreB} ${map[m.pairB] || '?'} <button data-edit="${m.id}" class="text-blue-600"><i class="ti ti-pencil"></i></button> <button data-del="${m.id}" class="text-red-600"><i class="ti ti-trash"></i></button>`;
        historyList.appendChild(li);
    });
}

historyList.onclick = async e => {
    if (e.target.dataset.edit) {
        const id = e.target.dataset.edit;
        const match = currentMatches.find(m => m.id === id);
        if (match) {
            pairASelect.value = match.pairA;
            pairBSelect.value = match.pairB;
            document.getElementById('scoreA').value = match.scoreA;
            document.getElementById('scoreB').value = match.scoreB;
            matchForm.dataset.stage = match.stage || 'RR';
            editingMatchId = id;
        }
    } else if (e.target.dataset.del) {
        const id = e.target.dataset.del;
        if (confirm('Eliminar partido?')) {
            await deleteDoc(doc(db, 'matches', id));
        }
    }
};

function renderElimination(pairs, matches) {
    const rrMatches = matches.filter(m => (m.stage || 'RR') === 'RR');
    const stats = computeStats(pairs, rrMatches);
    stats.sort((a,b) => b.jg - a.jg || (b.pf - b.pc) - (a.pf - a.pc));
    const top4 = stats.slice(0,4);
    const map = Object.fromEntries(pairs.map(p => [p.id, `${p.zaguero} / ${p.delantero}`]));
    const sfMatches = matches.filter(m => m.stage === 'SF');
    const fMatch = matches.find(m => m.stage === 'F');

    eliminationBracket.innerHTML = '';
    if (top4.length < 4) {
        eliminationBracket.textContent = 'Esperando resultados de ronda inicial.';
        return;
    }

    const sf1 = sfMatches.find(m => m.match === 'SF1');
    const sf2 = sfMatches.find(m => m.match === 'SF2');

    const createSFForm = (label, aId, bId, dataMatch, existing) => {
        const form = document.createElement('form');
        form.className = 'grid grid-cols-2 gap-2 items-center';
        form.dataset.stage = 'SF';
        form.dataset.match = dataMatch;
        form.innerHTML = `
            <span class="col-span-2 font-semibold">${label}</span>
            <select class="border p-2 rounded" name="a"></select>
            <input class="border p-2 rounded" name="sa" type="number" min="0" />
            <span class="col-span-2 text-center">vs</span>
            <select class="border p-2 rounded" name="b"></select>
            <input class="border p-2 rounded" name="sb" type="number" min="0" />
            <button type="submit" class="bg-green-600 text-white rounded p-2 col-span-2">Guardar</button>`;
        const selA = form.querySelector('select[name="a"]');
        const selB = form.querySelector('select[name="b"]');
        [aId,bId].forEach((id,idx) => {
            const opt = document.createElement('option');
            opt.value = id;
            opt.textContent = map[id];
            if (idx===0) selA.appendChild(opt); else selB.appendChild(opt);
        });
        if (existing) {
            selA.value = existing.pairA;
            selB.value = existing.pairB;
            form.querySelector('input[name="sa"]').value = existing.scoreA;
            form.querySelector('input[name="sb"]').value = existing.scoreB;
        }
        form.onsubmit = async ev => {
            ev.preventDefault();
            const pairA = selA.value;
            const pairB = selB.value;
            const scoreA = parseInt(form.querySelector('input[name="sa"]').value)||0;
            const scoreB = parseInt(form.querySelector('input[name="sb"]').value)||0;
            const data = { pairA, pairB, scoreA, scoreB, stage:'SF', match:dataMatch, ts:Date.now() };
            if (existing) {
                await updateDoc(doc(db,'matches', existing.id), data);
            } else {
                await addDoc(collection(db,'matches'), data);
            }
            form.reset();
        };
        return form;
    };

    eliminationBracket.appendChild(createSFForm('Semifinal 1', top4[0].id, top4[3].id, 'SF1', sf1));
    eliminationBracket.appendChild(createSFForm('Semifinal 2', top4[1].id, top4[2].id, 'SF2', sf2));

    const createFinalForm = (existing) => {
        if (!sf1 || !sf2) {
            const div = document.createElement('div');
            div.textContent = 'Esperando semifinales.';
            return div;
        }
        const winners = [];
        [sf1, sf2].forEach(sf => {
            if (sf.scoreA > sf.scoreB) winners.push(sf.pairA); else if (sf.scoreB > sf.scoreA) winners.push(sf.pairB);
        });
        if (winners.length < 2) {
            const div = document.createElement('div');
            div.textContent = 'Esperando semifinales.';
            return div;
        }
        const form = document.createElement('form');
        form.className = 'grid grid-cols-2 gap-2 items-center mt-4';
        form.dataset.stage = 'F';
        form.innerHTML = `
            <span class="col-span-2 font-semibold">Final</span>
            <select class="border p-2 rounded" name="a"></select>
            <input class="border p-2 rounded" name="sa" type="number" min="0" />
            <span class="col-span-2 text-center">vs</span>
            <select class="border p-2 rounded" name="b"></select>
            <input class="border p-2 rounded" name="sb" type="number" min="0" />
            <button type="submit" class="bg-green-600 text-white rounded p-2 col-span-2">Guardar</button>`;
        const selA = form.querySelector('select[name="a"]');
        const selB = form.querySelector('select[name="b"]');
        winners.forEach((id,idx)=>{
            const opt = document.createElement('option');
            opt.value = id;
            opt.textContent = map[id];
            if(idx===0) selA.appendChild(opt); else selB.appendChild(opt);
        });
        if (existing) {
            selA.value = existing.pairA;
            selB.value = existing.pairB;
            form.querySelector('input[name="sa"]').value = existing.scoreA;
            form.querySelector('input[name="sb"]').value = existing.scoreB;
        }
        form.onsubmit = async ev => {
            ev.preventDefault();
            const pairA = selA.value;
            const pairB = selB.value;
            const scoreA = parseInt(form.querySelector('input[name="sa"]').value)||0;
            const scoreB = parseInt(form.querySelector('input[name="sb"]').value)||0;
            const data = { pairA, pairB, scoreA, scoreB, stage:'F', ts:Date.now() };
            if (existing) {
                await updateDoc(doc(db,'matches', existing.id), data);
            } else {
                await addDoc(collection(db,'matches'), data);
            }
            form.reset();
        };
        return form;
    };

    eliminationBracket.appendChild(createFinalForm(fMatch));
}

async function loadData() {
    const pairSnap = await getDocs(collection(db, 'pairs'));
    const pairs = pairSnap.docs.map(d => ({ id: d.id, ...d.data() }));
    const matchSnap = await getDocs(collection(db, 'matches'));
    const matches = matchSnap.docs.map(d => ({ id: d.id, ...d.data() }));
    const playerSnap = await getDocs(collection(db, 'players'));
    const players = playerSnap.docs.map(d => ({ id: d.id, ...d.data() }));
    currentPairs = pairs;
    currentMatches = matches;
    currentPlayers = players;
    renderPairs(pairs);
    renderPlayers(players);
    renderStats(computeStats(pairs, matches.filter(m => (m.stage || 'RR') === 'RR')));
    renderHistory(pairs, matches);
    renderElimination(pairs, matches);
}

onSnapshot(collection(db, 'pairs'), loadData);
onSnapshot(collection(db, 'matches'), loadData);
onSnapshot(collection(db, 'players'), loadData);
loadData();
</script>
</body>
</html>
